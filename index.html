<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ä–µ–º–µ–Ω–∞ –∑–∞ –ù–∞–º–∞–∑</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #2d3748; /* Slightly lighter dark background for the card */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2rem;
            width: 100%;
            max-width: 480px; /* Default max width for mobile */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        /* Responsive max-width for larger screens */
        @media (min-width: 768px) { /* md breakpoint */
            .container {
                max-width: 640px; /* md:max-w-xl */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .container {
                max-width: 768px; /* lg:max-w-2xl */
            }
        }

        .time-display {
            font-size: 5rem; /* Slightly larger current time */
            font-weight: 700;
            color: #a0aec0; /* Lighter grey for time */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .countdown-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: #cbd5e0;
            margin-top: 0.5rem; 
        }
        .prayer-row {
            display: flex;
            justify-content: space-between; /* Keeps name left, and time/button group right */
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568; /* Subtle separator */
        }
        .prayer-row:last-child {
            border-bottom: none;
        }
        .prayer-name {
            font-size: 1.125rem;
            font-weight: 500;
            color: #cbd5e0;
        }
        .prayer-time {
            font-size: 1.25rem;
            font-weight: 600;
            color: #a0aec0;
        }
        .highlighted-prayer .prayer-name,
        .highlighted-prayer .prayer-time {
            color: #68d391; /* Highlight color */
            font-weight: 700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #68d391;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* General button style for location and date */
        .action-button {
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #68d391;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap; /* Prevent text wrapping */
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .action-button:hover {
            background-color: #5a677d;
        }
        .action-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.5);
        }

        /* Styling for the date button itself */
        .date-picker-button {
            padding: 0.5rem; /* Smaller padding for emoji-only button */
            min-width: auto; /* Remove min-width inherited from action-button */
            width: 3rem; /* Fixed width for emoji button */
            height: 3rem; /* Fixed height for emoji button */
            font-size: 1.5rem; /* Larger emoji */
        }
        
        /* Hidden input for date selection */
        .hidden-date-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            backdrop-filter: blur(5px); /* Optional: blur background */
        }
        .modal-content {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #e2e8f0;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling for long lists */
        }
        .city-list-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .city-list-item:hover {
            background-color: #3a475d;
        }
        .city-list-item:last-child {
            border-bottom: none;
        }
        .city-list-item.selected {
            background-color: #68d391;
            color: #1a202c;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container">
        <!-- Top row: Gregorian Date & Day (left), Hijri Date & Sacred Day (right) -->
        <div class="flex justify-between items-start mb-4 text-sm md:text-base">
            <div id="gregorian-date-info" class="flex flex-col items-start font-medium text-gray-400">
                <span id="current-date"></span>
                <span id="current-day"></span>
            </div>
            <div id="hijri-and-sacred-info" class="flex flex-col items-end text-gray-500">
                <span id="hijri-date"></span>
                <span id="sacred-day-info" class="text-green-400 font-semibold text-xs mt-1"></span>
            </div>
        </div>

        <!-- Second row: Location Select & Date Picker (left), Current Time & Save Button (right) -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                <!-- Location Button -->
                <button id="location-select-btn" class="action-button w-full md:w-auto">
                    üìç <span id="selected-city-display">–°–æ—Ñ–∏—è</span>
                </button>
                <!-- Date Button (emoji only) -->
                <div class="relative">
                    <button id="date-picker-btn" class="action-button date-picker-button">üóìÔ∏è</button>
                    <input type="date" id="hidden-date-input" class="hidden-date-input">
                </div>
            </div>
            <div class="flex items-center space-x-2 mt-4 md:mt-0">
                <div id="current-time" class="text-2xl md:text-xl font-semibold text-gray-300"></div>
                <button id="save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white text-lg py-1 px-2 rounded-lg focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">üíæ</button>
            </div>
        </div>

        <div class="text-center">
            <div id="countdown" class="time-display">--:--:--</div>
            <div id="countdown-text" class="countdown-text">–∑–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
        </div>

        <div id="prayer-times-list" class="flex flex-col gap-2">
            <div class="flex justify-center items-center py-8" id="loading-indicator">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div id="error-message" class="hidden text-center text-red-400 text-sm mt-4">
            –í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–∞—Ç–∞ –∑–∞ –Ω–∞–º–∞–∑. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ –ø–æ-–∫—ä—Å–Ω–æ.
        </div>
    </div>

    <!-- City Selection Modal -->
    <div id="city-selection-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4">–ò–∑–±–µ—Ä–µ—Ç–µ –≥—Ä–∞–¥</h3>
            <div id="city-list" class="flex flex-col gap-2 mb-6">
                <!-- City options will be populated here by JavaScript -->
            </div>
            <div class="flex justify-end">
                <button id="close-city-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <!-- Prayer Adjustment Modal -->
    <div id="adjustment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4" id="modal-prayer-name"></h3>
            <p class="text-gray-300 text-sm mb-4">–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ—Ä–µ–∫—Ü–∏—è –≤ –º–∏–Ω—É—Ç–∏ (+ –∑–∞ –Ω–∞–ø—Ä–µ–¥, - –∑–∞ –Ω–∞–∑–∞–¥):</p>
            <div class="mb-6">
                <label for="adjusted-minutes-offset" class="sr-only">–ö–æ—Ä–µ–∫—Ü–∏—è –≤ –º–∏–Ω—É—Ç–∏:</label>
                <input type="number" id="adjusted-minutes-offset" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-600 border-gray-500 text-white" placeholder="–ù–∞–ø—Ä. 5 –∏–ª–∏ -3">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-adjustment-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">–û—Ç–∫–∞–∑</button>
                <button id="save-adjustment-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">–ó–∞–ø–∞–∑–∏</button>
            </div>
        </div>
    </div>

    <script>
        // --- SACRED DAYS DATA (EXAMPLE) ---
        // This is a hardcoded example list of sacred days for demonstration.
        // For a comprehensive solution, this data would need to be pre-generated for many years.
        const sacredDays = {
            "2024-06-06": "–î–µ–Ω—è—Ç –ê—Ä–∞—Ñ–∞", 
            "2024-06-16": "–†–∞–º–∞–∑–∞–Ω –ë–∞–π—Ä–∞–º", 
            "2025-06-06": "–ö—É—Ä–±–∞–Ω –ë–∞–π—Ä–∞–º - –î–µ–Ω 1", 
            "2025-06-07": "–ö—É—Ä–±–∞–Ω –ë–∞–π—Ä–∞–º - –î–µ–Ω 2",
            "2025-06-08": "–ö—É—Ä–±–∞–Ω –ë–∞–π—Ä–∞–º - –î–µ–Ω 3",
            "2025-06-09": "–ö—É—Ä–±–∞–Ω –ë–∞–π—Ä–∞–º - –î–µ–Ω 4",
            "2025-07-27": "–ù–æ—â—Ç–∞ –ú–∏—Ä–∞–¥–∂",
            "2025-08-13": "–ù–æ—â—Ç–∞ –ë–µ—Ä–∞—Ç",
            // ... –¥–æ–±–∞–≤–µ—Ç–µ –æ—â–µ —Å–≤–µ—â–µ–Ω–∏ –¥–Ω–∏ –∏ –Ω–æ—â–∏ –∑–∞ –¥—Ä—É–≥–∏ –≥–æ–¥–∏–Ω–∏.
        };
        // --- END OF SACRED DAYS DATA ---


        // DOM Elements
        const currentTimeEl = document.getElementById('current-time');
        const countdownEl = document.getElementById('countdown');
        const countdownTextEl = document.getElementById('countdown-text');
        const currentDateEl = document.getElementById('current-date');
        const currentDayEl = document.getElementById('current-day');
        const hijriDateEl = document.getElementById('hijri-date');
        const sacredDayInfoEl = document.getElementById('sacred-day-info'); 
        const prayerTimesListEl = document.getElementById('prayer-times-list');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const errorMessageEl = document.getElementById('error-message');
        const locationSelectBtn = document.getElementById('location-select-btn'); 
        const selectedCityDisplay = document.getElementById('selected-city-display'); 
        const datePickerBtn = document.getElementById('date-picker-btn'); // The new button for date picker
        const hiddenDateInput = document.getElementById('hidden-date-input'); // The actual hidden date input
        const saveSettingsBtn = document.getElementById('save-settings-btn'); 

        // Modals and their elements
        const citySelectionModal = document.getElementById('city-selection-modal');
        const cityListEl = document.getElementById('city-list');
        const closeCityModalBtn = document.getElementById('close-city-modal-btn');

        const adjustmentModal = document.getElementById('adjustment-modal');
        const modalPrayerNameEl = document.getElementById('modal-prayer-name');
        const adjustedMinutesOffsetInput = document.getElementById('adjusted-minutes-offset');
        const cancelAdjustmentBtn = document.getElementById('cancel-adjustment-btn');
        const saveAdjustmentBtn = document.getElementById('save-adjustment-btn');

        // Prayer names in Bulgarian (Dhuhr will be handled conditionally)
        const prayerNamesBg = {
            Fajr: '–ó–æ—Ä–∞',
            Sunrise: '–ò–∑–≥—Ä–µ–≤',
            Dhuhr: '–û–±–µ–¥–Ω–∞', 
            Asr: '–°–ª–µ–¥–æ–±–µ–¥–Ω–∞',
            Maghrib: '–í–µ—á–µ—Ä–Ω–∞',
            Isha: '–ù–æ—â–Ω–∞'
        };

        // General prayer-specific adjustments in minutes (applied on top of base times)
        const adjustments = {
            Fajr: 0,
            Sunrise: -7,
            Dhuhr: 5,
            Asr: 4,
            Maghrib: 6,
            Isha: 0 
        };

        // Custom city offsets relative to Sofia (minutes to be added/subtracted from Sofia's times)
        // These offsets will now be applied to the API-fetched times for Sofia.
        const cityOffsets = {
            "–°–æ—Ñ–∏—è": 0, // Base city, no offset
            "–ì–æ—Ü–µ –î–µ–ª—á–µ–≤": -1,
            "–Ø–∫–æ—Ä—É–¥–∞": -1,
            "–í–µ–ª–∏–Ω–≥—Ä–∞–¥": -3,
            "–ö–Ω–µ–∂–∞": -3,
            "–õ–æ–≤–µ—á": -5,
            "–°–º–æ–ª—è–Ω": -5,
            "–ü–ª–æ–≤–¥–∏–≤": -5,
            "–ü–ª–µ–≤–µ–Ω": -5,
            "–ú–∞–¥–∞–Ω": -6,
            "–ù–∏–∫–æ–ø–æ–ª": -6,
            "–ö–∞—Ä–ª–æ–≤–æ": -6,
            "–°–≤–∏—â–æ–≤": -8,
            "–ö—ä—Ä–¥–∂–∞–ª–∏": -8,
            "–ö—Ä—É–º–æ–≤–≥—Ä–∞–¥": -9,
            "–í–µ–ª–∏–∫–æ –¢—ä—Ä–Ω–æ–≤–æ": -9,
            "–°—Ç–∞—Ä–∞ –ó–∞–≥–æ—Ä–∞": -9,
            "–•–∞—Å–∫–æ–≤–æ": -9,
            "–ì–æ—Ä–Ω–∞ –û—Ä—è—Ö–æ–≤–∏—Ü–∞": -9,
            "–†—É—Å–µ": -10,
            "–¢–≤—ä—Ä–¥–∏—Ü–∞": -10,
            "–•–∞—Ä–º–∞–Ω–ª–∏": -10,
            "–ù–æ–≤–∞ –ó–∞–≥–æ—Ä–∞": -10,
            "–ö—É–±—Ä–∞—Ç": -12,
            "–†–∞–∑–≥—Ä–∞–¥": -12,
            "–ö–æ—Ç–µ–ª": -12,
            "–°–ª–∏–≤–µ–Ω": -12,
            "–Ø–º–±–æ–ª": -12,
            "–ò—Å–ø–µ—Ä–∏—Ö": -13,
            "–í–µ–ª–∏–∫–∏ –ü—Ä–µ—Å–ª–∞–≤": -13,
            "–¢—ä—Ä–≥–æ–≤–∏—â–µ": -13,
            "–°–∏—Ç–æ–≤–æ": -14,
            "–ö–∞–æ–ª–∏–Ω–æ–≤–æ": -14,
            "–ö–∞—Ä–Ω–æ–±–∞—Ç": -14,
            "–®—É–º–µ–Ω": -14,
            "–ù–æ–≤–∏ –ü–∞–∑–∞—Ä": -15,
            "–ê–π—Ç–æ—Å": -15,
            "–ü—Ä–æ–≤–∞–¥–∏—è": -16,
            "–ë—É—Ä–≥–∞—Å": -16,
            "–°–∏–ª–∏—Å—Ç—Ä–∞": -16,
            "–î–æ–±—Ä–∏—á": -17,
            "–ë—è–ª–∞": -17,
            "–ë–∞–ª—á–∏–∫": -18,
            "–í–∞—Ä–Ω–∞": -18,
            "–ö–∞–≤–∞—Ä–Ω–∞": -19
        };

        // Mapping for Hijri month names to Bulgarian
        const hijriMonthsBg = {
            "Muharram": "–ú—É—Ö–∞—Ä—Ä–µ–º",
            "Safar": "–°–∞—Ñ–µ—Ä",
            "Rabi' al-Awwal": "–†–∞–±–∏—é–ª–µ–≤–≤–µ–ª",
            "Rabi' al-Thani": "–†–∞–±–∏—é–ª–∞—Ö–∏—Ä",
            "Jumada al-Awwal": "–î–∂–µ–º–∞–∑–∏—é–ª–µ–≤–≤–µ–ª",
            "Jumada al-Thani": "–î–∂–µ–º–∞–∑–∏—é–ª–∞—Ö–∏—Ä",
            "Rajab": "–†–µ–¥–∂–µ–±",
            "Sha'ban": "–®–∞–±–∞–Ω",
            "Ramadan": "–†–∞–º–∞–∑–∞–Ω",
            "Shawwal": "–®–µ–≤–≤–∞–ª",
            "Dhul-Qadah": "–ó–∏–ª–∫–∞–¥–µ",
            "Dhul-Hijjah": "–ó–∏–ª—Ö–∏–¥–∂–µ"
        };


        let prayerTimes = {}; // Stores fetched prayer times (after all adjustments for selected city)
        let nextPrayerIndex = -1; // Index of the next prayer in the list
        let selectedCity = "–°–æ—Ñ–∏—è"; // Default selected city
        let currentHijriDate = ''; // To store and display Hijri date
        let selectedDate = new Date(); // Stores the currently selected date (defaults to today)
        let customPrayerAdjustments = {}; // Stores user-defined adjustments for each prayer {Fajr: 5, Dhuhr: -2}
        let currentAdjustingPrayer = null; // To keep track of which prayer is being adjusted in the modal

        // Populate city list in modal
        function populateCityList() {
            cityListEl.innerHTML = ''; // Clear previous list
            const sortedCities = Object.keys(cityOffsets).sort((a, b) => {
                if (a === "–°–æ—Ñ–∏—è") return -1;
                if (b === "–°–æ—Ñ–∏—è") return 1;
                return a.localeCompare(b);
            });

            sortedCities.forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.className = 'city-list-item';
                if (city === selectedCity) {
                    cityItem.classList.add('selected');
                }
                cityItem.textContent = city;
                cityItem.dataset.city = city;
                cityItem.addEventListener('click', () => {
                    selectedCity = city;
                    selectedCityDisplay.textContent = selectedCity; // Update display button text
                    closeCitySelectionModal();
                    fetchPrayerTimes(); // Re-fetch times for the new city
                });
                cityListEl.appendChild(cityItem);
            });
        }

        // Function to format time to HH:MM
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Function to format date to DD.MM.YYYY
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Function to format date to YYYY-MM-DD for input type="date" and API calls
        function formatDateForInputAndLookup(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to get day of the week in Bulgarian
        function getDayNameBg(date) {
            const days = ['–ù–µ–¥–µ–ª—è', '–ü–æ–Ω–µ–¥–µ–ª–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä—è–¥–∞', '–ß–µ—Ç–≤—ä—Ä—Ç—ä–∫', '–ü–µ—Ç—ä–∫', '–°—ä–±–æ—Ç–∞'];
            return days[date.getDay()];
        }

        // Function to determine Dhuhr name based on day of the week
        function getDhuhrName(date) {
            return date.getDay() === 5 ? '–î–∂—É–º–∞' : '–û–±–µ–¥–Ω–∞'; // Friday is 5
        }

        // Function to update the current time display
        function updateClock() {
            const now = new Date();
            currentTimeEl.textContent = formatTime(now);
        }

        // Function to fetch prayer times from API
        async function fetchPrayerTimes() {
            loadingIndicatorEl.classList.remove('hidden');
            errorMessageEl.classList.add('hidden'); 
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            const dateKey = formatDateForInputAndLookup(selectedDate);
            const currentDateStringForAPI = `${String(selectedDate.getDate()).padStart(2, '0')}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${selectedDate.getFullYear()}`;

            // Update Gregorian date and day display
            currentDateEl.textContent = formatDate(selectedDate);
            currentDayEl.textContent = getDayNameBg(selectedDate);
            selectedCityDisplay.textContent = selectedCity; // Update the city display button

            // Fetch base times for Sofia using Diyanet method (method=10)
            const diyanetApiUrl = `https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=10`;
            
            // Fetch Isha time specifically using Muslim World League method (method=3)
            const mwlIshaApiUrl = `https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=3`;

            try {
                const [diyanetResponse, mwlIshaResponse] = await Promise.all([
                    fetch(diyanetApiUrl),
                    fetch(mwlIshaApiUrl)
                ]);

                if (!diyanetResponse.ok || !mwlIshaResponse.ok) {
                    throw new Error(`HTTP error! Statuses: Diyanet ${diyanetResponse.status}, MWL ${mwlIshaResponse.status}`);
                }

                const diyanetData = await diyanetResponse.json();
                const mwlIshaData = await mwlIshaResponse.json();

                if (diyanetData.data && diyanetData.data.timings && diyanetData.data.date && diyanetData.data.date.hijri &&
                    mwlIshaData.data && mwlIshaData.data.timings) {
                    
                    // Combine timings: Diyanet for all, MWL for Isha
                    const sofiaBaseTimings = {
                        Fajr: diyanetData.data.timings.Fajr,
                        Sunrise: diyanetData.data.timings.Sunrise,
                        Dhuhr: diyanetData.data.timings.Dhuhr,
                        Asr: diyanetData.data.timings.Asr,
                        Maghrib: diyanetData.data.timings.Maghrib,
                        Isha: mwlIshaData.data.timings.Isha // Override Isha with MWL time
                    };

                    const currentCityCustomOffset = cityOffsets[selectedCity] || 0;
                    const adjustedPrayerTimes = {};

                    // Apply general and city-specific offsets to the API-fetched Sofia times
                    for (const key in sofiaBaseTimings) {
                        if (sofiaBaseTimings.hasOwnProperty(key)) {
                            let [hour, minute] = sofiaBaseTimings[key].split(':').map(Number);
                            let tempDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hour, minute, 0);

                            // Apply general prayer-specific adjustment
                            if (adjustments[key] !== undefined) { 
                                tempDate.setMinutes(tempDate.getMinutes() + adjustments[key]);
                            }
                            // Apply city-specific custom offset
                            tempDate.setMinutes(tempDate.getMinutes() + currentCityCustomOffset);

                            // Apply custom user adjustment (from local storage)
                            if (customPrayerAdjustments[key] !== undefined) {
                                tempDate.setMinutes(tempDate.getMinutes() + customPrayerAdjustments[key]);
                            }

                            adjustedPrayerTimes[key] = formatTime(tempDate);
                        }
                    }
                    
                    prayerTimes = adjustedPrayerTimes; // Store the fully adjusted times

                    // Extract and format Hijri date (from Diyanet data, as it's the main source for Hijri)
                    const hijri = diyanetData.data.date.hijri;
                    const hijriDay = hijri.day;
                    const hijriMonthEnglish = hijri.month.en;
                    const hijriYear = hijri.year;
                    const hijriMonthBg = hijriMonthsBg[hijriMonthEnglish] || hijriMonthEnglish; 
                    currentHijriDate = `${hijriDay} ${hijriMonthBg} ${hijriYear} –≥.`; 
                    hijriDateEl.textContent = currentHijriDate;

                    // Check and display sacred day/night
                    const sacredDayKey = formatDateForInputAndLookup(selectedDate);
                    if (sacredDays[sacredDayKey]) {
                        sacredDayInfoEl.textContent = sacredDays[sacredDayKey]; // Display without date in parentheses
                        sacredDayInfoEl.classList.remove('hidden');
                    } else {
                        sacredDayInfoEl.textContent = '';
                        sacredDayInfoEl.classList.add('hidden');
                    }

                    displayPrayerTimes(); 
                } else {
                    throw new Error('–ù–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç API –∏–ª–∏ –ª–∏–ø—Å–≤–∞—â–∏ –¥–∞–Ω–Ω–∏.');
                }
            } catch (error) {
                console.error('Error fetching prayer times:', error);
                errorMessageEl.classList.remove('hidden');
                errorMessageEl.textContent = '–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–∞—Ç–∞ –∑–∞ –Ω–∞–º–∞–∑. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–∏ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.';
                // Clear displayed prayer times and Hijri/Sacred info on error
                prayerTimes = {};
                prayerTimesListEl.innerHTML = '';
                hijriDateEl.textContent = '';
                sacredDayInfoEl.textContent = '';
                sacredDayInfoEl.classList.add('hidden');
            } finally {
                loadingIndicatorEl.classList.add('hidden');
            }
        }

        // Function to display prayer times in the list
        function displayPrayerTimes() {
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            const now = new Date(); // Keep current time for clock display
            const targetDate = selectedDate; // Use selectedDate for prayer time calculations
            
            let prayersArray = [];
            for (const key in prayerTimes) {
                if (prayerTimes.hasOwnProperty(key)) {
                    const [hour, minute] = prayerTimes[key].split(':').map(Number);
                    let prayerDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), hour, minute, 0);

                    let displayName = prayerNamesBg[key] || key;
                    if (key === 'Dhuhr') {
                        displayName = getDhuhrName(targetDate);
                    }

                    prayersArray.push({
                        name: key, // Original key for internal logic
                        displayName: displayName, // Name to display
                        time: formatTime(prayerDate), // Format adjusted time
                        date: prayerDate
                    });
                }
            }

            // Sort prayers by time to ensure correct order
            prayersArray.sort((a, b) => a.date.getTime() - b.date.getTime());

            // Find the next prayer only if the selected date is today
            if (selectedDate.toDateString() === new Date().toDateString()) {
                nextPrayerIndex = -1;
                for (let i = 0; i < prayersArray.length; i++) {
                    if (prayersArray[i].date > now) { // Compare with actual current time
                        nextPrayerIndex = i;
                        break;
                    }
                }
                if (nextPrayerIndex === -1 && prayersArray.length > 0) {
                    nextPrayerIndex = 0; // Set to Fajr for countdown, but indicate it's for tomorrow
                }
            } else {
                nextPrayerIndex = -1; // No "next prayer" highlight or countdown for past/future dates
            }


            // Render prayer times
            prayersArray.forEach((prayer, index) => {
                const prayerRow = document.createElement('div');
                prayerRow.className = 'prayer-row';

                // Highlight the current/next prayer only if today's date is selected
                if (selectedDate.toDateString() === new Date().toDateString() && index === nextPrayerIndex) {
                    prayerRow.classList.add('highlighted-prayer');
                }

                prayerRow.innerHTML = `
                    <span class="prayer-name">${prayer.displayName}</span>
                    <div class="flex items-center"> <!-- Group time and button together -->
                        <span class="prayer-time">${prayer.time}</span>
                        <button class="adjust-prayer-btn text-gray-500 hover:text-green-400 text-lg ml-2" data-prayer-name="${prayer.name}">‚öôÔ∏è</button>
                    </div>
                `;
                prayerTimesListEl.appendChild(prayerRow);
            });

            // Add event listener for the adjustment buttons using delegation
            // This ensures listeners work even if prayer rows are re-rendered
            prayerTimesListEl.querySelectorAll('.adjust-prayer-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const prayerName = event.currentTarget.dataset.prayerName;
                    openAdjustmentModal(prayerName);
                });
            });

            updateCountdown(); // Start/update countdown after displaying times
        }

        // Function to update the countdown to the next prayer
        function updateCountdown() {
            if (Object.keys(prayerTimes).length === 0 || selectedDate.toDateString() !== new Date().toDateString()) {
                countdownEl.textContent = '--:--:--';
                countdownTextEl.textContent = '–ù—è–º–∞ –æ—Ç–±—Ä–æ—è–≤–∞–Ω–µ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –¥–∞—Ç–∞.';
                return;
            }

            const now = new Date();
            let nextPrayerTimeDate;
            let nextPrayerDisplayName;

            // Recalculate prayersArray with ALL current adjustments for countdown
            let prayersArrayForCountdown = [];
            const currentCityCustomOffset = cityOffsets[selectedCity] || 0;
            const currentDateStringForAPI = `${String(selectedDate.getDate()).padStart(2, '0')}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${selectedDate.getFullYear()}`;
            
            // Re-fetch base times for Sofia to apply dynamic adjustments
            Promise.all([
                fetch(`https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=10`),
                fetch(`https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=3`)
            ]).then(async ([diyanetResponse, mwlIshaResponse]) => {
                const diyanetData = await diyanetResponse.json();
                const mwlIshaData = await mwlIshaResponse.json();

                if (!diyanetData.data || !diyanetData.data.timings || !mwlIshaData.data || !mwlIshaData.data.timings) {
                    console.error('Missing data from API for countdown calculation.');
                    countdownEl.textContent = '--:--:--';
                    countdownTextEl.textContent = '–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –¥–∞—Ç–∞.';
                    return;
                }

                const sofiaBaseTimingsForCountdown = {
                    Fajr: diyanetData.data.timings.Fajr,
                    Sunrise: diyanetData.data.timings.Sunrise,
                    Dhuhr: diyanetData.data.timings.Dhuhr,
                    Asr: diyanetData.data.timings.Asr,
                    Maghrib: diyanetData.data.timings.Maghrib,
                    Isha: mwlIshaData.data.timings.Isha 
                };

                for (const key in sofiaBaseTimingsForCountdown) {
                    if (sofiaBaseTimingsForCountdown.hasOwnProperty(key)) {
                        const [hour, minute] = sofiaBaseTimingsForCountdown[key].split(':').map(Number);
                        let prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);

                        if (adjustments[key] !== undefined) {
                            prayerDate.setMinutes(prayerDate.getMinutes() + adjustments[key]);
                        }
                        prayerDate.setMinutes(prayerDate.getMinutes() + currentCityCustomOffset);

                        if (customPrayerAdjustments[key] !== undefined) {
                            prayerDate.setMinutes(prayerDate.getMinutes() + customPrayerAdjustments[key]);
                        }

                        let displayName = prayerNamesBg[key] || key;
                        if (key === 'Dhuhr') {
                            displayName = getDhuhrName(now);
                        }

                        prayersArrayForCountdown.push({
                            name: key,
                            displayName: displayName,
                            time: formatTime(prayerDate),
                            date: prayerDate
                        });
                    }
                }
                prayersArrayForCountdown.sort((a, b) => a.date.getTime() - b.date.getTime());

                nextPrayerIndex = -1; 
                for (let i = 0; i < prayersArrayForCountdown.length; i++) {
                    if (prayersArrayForCountdown[i].date > now) {
                        nextPrayerIndex = i;
                        break;
                    }
                }
                
                if (nextPrayerIndex === -1 && prayersArrayForCountdown.length > 0) {
                    nextPrayerIndex = 0; 
                    const nextDayFajr = new Date(prayersArrayForCountdown[0].date);
                    nextDayFajr.setDate(nextDayFajr.getDate() + 1);
                    nextPrayerTimeDate = nextDayFajr;
                    nextPrayerDisplayName = prayersArrayForCountdown[0].displayName;
                    countdownTextEl.textContent = `–¥–æ ${nextPrayerDisplayName} —É—Ç—Ä–µ`;
                } else if (nextPrayerIndex !== -1) {
                    const nextPrayer = prayersArrayForCountdown[nextPrayerIndex];
                    nextPrayerTimeDate = nextPrayer.date;
                    nextPrayerDisplayName = nextPrayer.displayName;
                    countdownTextEl.textContent = `–¥–æ ${nextPrayerDisplayName}`;
                } else {
                    countdownEl.textContent = '00:00:00';
                    countdownTextEl.textContent = '–í—Å–∏—á–∫–∏ –Ω–∞–º–∞–∑–∏ –∑–∞ –¥–Ω–µ—Å —Å–∞ –º–∏–Ω–∞–ª–∏.';
                    return;
                }

                const diff = nextPrayerTimeDate.getTime() - now.getTime();

                if (diff <= 0) {
                    countdownEl.textContent = '00:00:00';
                    countdownTextEl.textContent = '–ù–∞–º–∞–∑—ä—Ç –µ —Å–µ–≥–∞!';
                    fetchPrayerTimes(); 
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }).catch(error => {
                console.error('Error fetching API data for countdown:', error);
                countdownEl.textContent = '--:--:--';
                countdownTextEl.textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –æ—Ç–±—Ä–æ—è–≤–∞–Ω–µ—Ç–æ.';
            });
        }

        // Function to fetch prayer times for the next day (called when all prayers for today have passed)
        function fetchPrayerTimesForNextDay() {
            const tomorrow = new Date(selectedDate);
            tomorrow.setDate(tomorrow.getDate() + 1);
            selectedDate = tomorrow; // Update selectedDate to tomorrow
            hiddenDateInput.value = formatDateForInputAndLookup(selectedDate); // Update hidden input value
            fetchPrayerTimes(); // Fetch times for the new selectedDate
        }

        // --- Modal Logic ---
        function openAdjustmentModal(prayerName) {
            currentAdjustingPrayer = prayerName;
            modalPrayerNameEl.textContent = `–ö–æ—Ä–µ–∫—Ü–∏—è –∑–∞ ${prayerNamesBg[prayerName] || prayerName}`;
            
            // Populate input with current custom adjustment for this prayer, default to 0
            adjustedMinutesOffsetInput.value = customPrayerAdjustments[prayerName] !== undefined ? customPrayerAdjustments[prayerName] : 0;
            
            adjustmentModal.classList.remove('hidden');
        }

        function closeAdjustmentModal() {
            adjustmentModal.classList.add('hidden');
            currentAdjustingPrayer = null;
            errorMessageEl.classList.add('hidden'); // Clear error message when closing modal
        }

        function saveIndividualAdjustment() {
            if (!currentAdjustingPrayer) return;

            const newOffset = parseInt(adjustedMinutesOffsetInput.value, 10);

            if (isNaN(newOffset)) {
                 errorMessageEl.textContent = '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–æ —á–∏—Å–ª–æ –∑–∞ –∫–æ—Ä–µ–∫—Ü–∏—è (–Ω–∞–ø—Ä. 5 –∏–ª–∏ -3).';
                 errorMessageEl.classList.remove('hidden');
                 return;
            }
            errorMessageEl.classList.add('hidden'); // Clear error if input is valid

            customPrayerAdjustments[currentAdjustingPrayer] = newOffset;
            saveSettings(); // Save all settings including new custom adjustment
            fetchPrayerTimes(); // Re-fetch and display with new custom adjustment
            closeAdjustmentModal();
        }

        function openCitySelectionModal() {
            populateCityList(); // Populate list before opening
            citySelectionModal.classList.remove('hidden');
        }

        function closeCitySelectionModal() {
            citySelectionModal.classList.add('hidden');
        }

        // --- Local Storage Functions ---
        function saveSettings() {
            const settingsToSave = {
                selectedCity: selectedCity,
                selectedDate: formatDateForInputAndLookup(selectedDate), // Save as string
                customPrayerAdjustments: customPrayerAdjustments
            };
            try {
                localStorage.setItem('prayerApp_settings', JSON.stringify(settingsToSave));
                // Optionally provide user feedback:
                // console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –∑–∞–ø–∞–∑–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ!");
            } catch (e) {
                console.error("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –≤ localStorage:", e);
                errorMessageEl.textContent = '–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ.';
                errorMessageEl.classList.remove('hidden');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('prayerApp_settings'));
                if (savedSettings) {
                    selectedCity = savedSettings.selectedCity || "–°–æ—Ñ–∏—è";
                    if (savedSettings.selectedDate) {
                        selectedDate = new Date(savedSettings.selectedDate);
                        // Ensure the date object is valid, fallback to today if not
                        if (isNaN(selectedDate.getTime())) {
                            selectedDate = new Date();
                        }
                    } else {
                        selectedDate = new Date(); // Default to today if not saved
                    }
                    customPrayerAdjustments = savedSettings.customPrayerAdjustments || {};
                    
                    // Update city display button to reflect loaded city
                    selectedCityDisplay.textContent = selectedCity;
                }
            } catch (e) {
                console.error("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –æ—Ç localStorage:", e);
                errorMessageEl.textContent = '–í—ä–∑–Ω–∏–∫–Ω–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ. –ò–∑–ø–æ–ª–∑–≤–∞—Ç —Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ.';
                errorMessageEl.classList.remove('hidden');
                // Optionally clear corrupted settings if needed: localStorage.removeItem('prayerApp_settings');
            }
        }

        // Initial setup and periodic updates
        window.onload = function() {
            loadSettings(); // Load settings first
            
            // Set initial value for the hidden date input based on loaded/default selectedDate
            hiddenDateInput.value = formatDateForInputAndLookup(selectedDate);
            
            updateClock(); // Start current time display
            fetchPrayerTimes(); // Initial fetch of prayer times using loaded settings

            // Event listener for Location button to open city selection modal
            locationSelectBtn.addEventListener('click', openCitySelectionModal);
            closeCityModalBtn.addEventListener('click', closeCitySelectionModal);

            // Event listener for the new date picker button to trigger the hidden input
            datePickerBtn.addEventListener('click', () => {
                hiddenDateInput.showPicker(); // Opens the native date picker
            });

            // Event listener for hidden date input change
            hiddenDateInput.addEventListener('change', (event) => {
                selectedDate = new Date(event.target.value);
                fetchPrayerTimes(); // Re-fetch times for the newly selected date
            });

            // Event listener for the main "Save Settings" button
            saveSettingsBtn.addEventListener('click', saveSettings);

            // Event listeners for modal buttons
            cancelAdjustmentBtn.addEventListener('click', closeAdjustmentModal);
            saveAdjustmentBtn.addEventListener('click', saveIndividualAdjustment);

            // Update clock every second
            setInterval(updateClock, 1000);
            // Update countdown every second (only active for today's date)
            setInterval(updateCountdown, 1000);
        };
    </script>
</body>
</html>
