<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Времена за Намаз</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #2d3748; /* Slightly lighter dark background for the card */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2rem;
            width: 100%;
            max-width: 480px; /* Max width for mobile-first design */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .time-display {
            font-size: 5rem; /* Slightly larger current time */
            font-weight: 700;
            color: #a0aec0; /* Lighter grey for time */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .countdown-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: #cbd5e0;
            margin-top: 0.5rem; 
        }
        .prayer-row {
            display: flex;
            justify-content: space-between; /* Keeps name left, and time/button group right */
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568; /* Subtle separator */
        }
        .prayer-row:last-child {
            border-bottom: none;
        }
        .prayer-name {
            font-size: 1.125rem;
            font-weight: 500;
            color: #cbd5e0;
        }
        .prayer-time {
            font-size: 1.25rem;
            font-weight: 600; 
            color: #a0aec0;
        }
        .highlighted-prayer .prayer-name,
        .highlighted-prayer .prayer-time {
            color: #68d391; /* Highlight color */
            font-weight: 700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #68d391;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the city select dropdown */
        .city-select {
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #68d391;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            appearance: none; /* Remove default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%23e2e8f0%22%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%205.757%206.586%204.343%208z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8em auto;
            min-width: 120px; /* Ensure it's wide enough */
        }
        .city-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.5); /* Focus ring */
        }
        /* Style for the date picker */
        .date-picker {
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #68d391;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            -webkit-appearance: none; /* Remove default date picker icon for WebKit browsers */
            appearance: none;
            text-align: center;
        }
        .date-picker::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Make the calendar icon white */
        }
        .date-picker:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.5); /* Focus ring */
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #e2e8f0;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container">
        <!-- Top row for Gregorian Date & Day (left) and Hijri Date (right) -->
        <div class="flex justify-between items-center mb-4">
            <div id="current-date-info" class="flex items-center space-x-2 text-lg font-medium text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 016.343 7.273L17.657 16.727zm0 0A8 8 0 0110.323 20.323L13.657 13.657m0 0a8 8 0 01-1.414 1.414L10.323 20.323m0 0A8 8 0 017.273 6.343L16.727 17.657m0 0a8 8 0 011.414-1.414L20.323 10.323M13.657 13.657a2 2 0 11-2.828-2.828 2 2 0 012.828 2.828z" />
                </svg>
                <span id="current-date"></span>
                <span class="mx-2">|</span>
                <span id="current-day"></span>
            </div>
            <div id="hijri-date" class="text-base text-gray-500 text-right"></div>
        </div>

        <!-- Second row for Location Select & Date Picker (left) and Current Time & Save Button (right) -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <select id="city-select" class="city-select"></select>
                <input type="date" id="date-picker" class="date-picker">
            </div>
            <div class="flex items-center space-x-2">
                <div id="current-time" class="text-xl font-semibold text-gray-300"></div>
                <button id="save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white text-lg py-1 px-2 rounded-lg focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">💾</button>
            </div>
        </div>

        <div class="text-center">
            <div id="countdown" class="time-display">--:--:--</div>
            <div id="countdown-text" class="countdown-text">зареждане...</div>
        </div>

        <div id="prayer-times-list" class="flex flex-col gap-2">
            <div class="flex justify-center items-center py-8" id="loading-indicator">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div id="error-message" class="hidden text-center text-red-400 text-sm mt-4">
            Възникна грешка при зареждане на времената за намаз. Моля, опитайте отново по-късно.
        </div>
    </div>

    <!-- Prayer Adjustment Modal -->
    <div id="adjustment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4" id="modal-prayer-name"></h3>
            <p class="text-gray-300 text-sm mb-4">Въведете корекция в минути (+ за напред, - за назад):</p>
            <div class="mb-6">
                <label for="adjusted-minutes-offset" class="sr-only">Корекция в минути:</label>
                <input type="number" id="adjusted-minutes-offset" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-600 border-gray-500 text-white" placeholder="Напр. 5 или -3">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-adjustment-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">Отказ</button>
                <button id="save-adjustment-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">Запази</button>
            </div>
        </div>
    </div>

    <script>
        // --- OFFLINE PRAYER DATA (REPLACE THIS WITH YOUR GENERATED DATA) ---
        // This object should contain pre-calculated prayer times for the BASE city (Sofia in this case).
        // The other cities' times will be derived from these base times using cityOffsets.
        // Format: { "YYYY-MM-DD": { Fajr: "HH:MM", Sunrise: "HH:MM", ..., hijri: { day: "", month: { en: "" }, year: "" } } }
        const offlinePrayerDataSofia = {
            // Данни за юни 2024 (София - базови времена от Диянет)
            "2024-06-01": { Fajr: "03:49", Sunrise: "05:29", Dhuhr: "13:00", Asr: "17:11", Maghrib: "20:26", Isha: "21:56", hijri: { day: "24", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-02": { Fajr: "03:48", Sunrise: "05:28", Dhuhr: "13:00", Asr: "17:12", Maghrib: "20:27", Isha: "21:57", hijri: { day: "25", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-03": { Fajr: "03:47", Sunrise: "05:27", Dhuhr: "13:00", Asr: "17:13", Maghrib: "20:28", Isha: "21:58", hijri: { day: "26", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-04": { Fajr: "03:46", Sunrise: "05:26", Dhuhr: "13:00", Asr: "17:14", Maghrib: "20:29", Isha: "21:59", hijri: { day: "27", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-05": { Fajr: "03:45", Sunrise: "05:25", Dhuhr: "13:00", Asr: "17:15", Maghrib: "20:30", Isha: "22:00", hijri: { day: "28", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-06": { Fajr: "03:44", Sunrise: "05:24", Dhuhr: "13:00", Asr: "17:16", Maghrib: "20:31", Isha: "22:01", hijri: { day: "29", month: { en: "Dhul-Qadah" }, year: "1445" } },
            "2024-06-07": { Fajr: "03:43", Sunrise: "05:23", Dhuhr: "13:00", Asr: "17:17", Maghrib: "20:32", Isha: "22:02", hijri: { day: "1", month: { en: "Dhul-Hijjah" }, year: "1445" } },
            "2024-06-08": { Fajr: "03:42", Sunrise: "05:22", Dhuhr: "13:00", Asr: "17:18", Maghrib: "20:33", Isha: "22:03", hijri: { day: "2", month: { en: "Dhul-Hijjah" }, year: "1445" } },
            "2024-06-09": { Fajr: "03:41", Sunrise: "05:21", Dhuhr: "13:00", Asr: "17:19", Maghrib: "20:34", Isha: "22:04", hijri: { day: "3", month: { en: "Dhul-Hijjah" }, year: "1445" } },
            "2024-06-10": { Fajr: "03:40", Sunrise: "05:20", Dhuhr: "13:00", Asr: "17:20", Maghrib: "20:35", Isha: "22:05", hijri: { day: "4", month: { en: "Dhul-Hijjah" }, year: "1445" } },
            // Данни за юни 2025 (София - базови времена от Диянет)
            "2025-06-01": { Fajr: "03:45", Sunrise: "05:25", Dhuhr: "13:00", Asr: "17:15", Maghrib: "20:30", Isha: "22:00", hijri: { day: "4", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-02": { Fajr: "03:44", Sunrise: "05:24", Dhuhr: "13:00", Asr: "17:16", Maghrib: "20:31", Isha: "22:01", hijri: { day: "5", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-03": { Fajr: "03:43", Sunrise: "05:23", Dhuhr: "13:00", Asr: "17:17", Maghrib: "20:32", Isha: "22:02", hijri: { day: "6", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-04": { Fajr: "03:42", Sunrise: "05:22", Dhuhr: "13:00", Asr: "17:18", Maghrib: "20:33", Isha: "22:03", hijri: { day: "7", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-05": { Fajr: "03:40", Sunrise: "05:20", Dhuhr: "13:05", Asr: "17:20", Maghrib: "20:35", Isha: "22:05", hijri: { day: "8", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-06": { Fajr: "03:39", Sunrise: "05:19", Dhuhr: "13:05", Asr: "17:21", Maghrib: "20:36", Isha: "22:06", hijri: { day: "9", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-07": { Fajr: "03:38", Sunrise: "05:18", Dhuhr: "13:05", Asr: "17:22", Maghrib: "20:37", Isha: "22:07", hijri: { day: "10", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-08": { Fajr: "03:37", Sunrise: "05:17", Dhuhr: "13:05", Asr: "17:23", Maghrib: "20:38", Isha: "22:08", hijri: { day: "11", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-09": { Fajr: "03:36", Sunrise: "05:16", Dhuhr: "13:05", Asr: "17:24", Maghrib: "20:39", Isha: "22:09", hijri: { day: "12", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            "2025-06-10": { Fajr: "03:35", Sunrise: "05:15", Dhuhr: "13:05", Asr: "17:25", Maghrib: "20:40", Isha: "22:10", hijri: { day: "13", month: { en: "Dhul-Hijjah" }, year: "1446" } },
            // ... Добавете още дати и години за София
        };
        // --- END OF OFFLINE PRAYER DATA ---


        // DOM Elements
        const currentTimeEl = document.getElementById('current-time');
        const countdownEl = document.getElementById('countdown');
        const countdownTextEl = document.getElementById('countdown-text');
        const currentDateEl = document.getElementById('current-date');
        const currentDayEl = document.getElementById('current-day');
        const hijriDateEl = document.getElementById('hijri-date');
        const prayerTimesListEl = document.getElementById('prayer-times-list');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const errorMessageEl = document.getElementById('error-message');
        const citySelectEl = document.getElementById('city-select');
        const datePickerEl = document.getElementById('date-picker');
        const saveSettingsBtn = document.getElementById('save-settings-btn'); // New button

        // Modal Elements
        const adjustmentModal = document.getElementById('adjustment-modal');
        const modalPrayerNameEl = document.getElementById('modal-prayer-name');
        const adjustedMinutesOffsetInput = document.getElementById('adjusted-minutes-offset');
        const cancelAdjustmentBtn = document.getElementById('cancel-adjustment-btn');
        const saveAdjustmentBtn = document.getElementById('save-adjustment-btn');

        // Prayer names in Bulgarian (Dhuhr will be handled conditionally)
        const prayerNamesBg = {
            Fajr: 'Зора',
            Sunrise: 'Изгрев',
            Asr: 'Следобедна',
            Maghrib: 'Вечерна',
            Isha: 'Нощна'
        };

        // General prayer-specific adjustments in minutes (applied on top of base times)
        const adjustments = {
            Fajr: 0,
            Sunrise: -7,
            Dhuhr: 5,
            Asr: 4,
            Maghrib: 6,
            Isha: 0 
        };

        // Custom city offsets relative to Sofia (minutes to be added/subtracted from Sofia's times)
        const cityOffsets = {
            "София": 0, // Base city, no offset
            "Гоце Делчев": -1,
            "Якоруда": -1,
            "Велинград": -3,
            "Кнежа": -3,
            "Ловеч": -5,
            "Смолян": -5,
            "Пловдив": -5,
            "Плевен": -5,
            "Мадан": -6,
            "Никопол": -6,
            "Карлово": -6,
            "Свищов": -8,
            "Кърджали": -8,
            "Крумовград": -9,
            "Велико Търново": -9,
            "Стара Загора": -9,
            "Хасково": -9,
            "Горна Оряховица": -9,
            "Русе": -10,
            "Твърдица": -10,
            "Харманли": -10,
            "Нова Загора": -10,
            "Кубрат": -12,
            "Разград": -12,
            "Котел": -12,
            "Сливен": -12,
            "Ямбол": -12,
            "Исперих": -13,
            "Велики Преслав": -13,
            "Търговище": -13,
            "Ситово": -14,
            "Каолиново": -14,
            "Карнобат": -14,
            "Шумен": -14,
            "Нови Пазар": -15,
            "Айтос": -15,
            "Провадия": -16,
            "Бургас": -16,
            "Силистра": -16,
            "Добрич": -17,
            "Бяла": -17,
            "Балчик": -18,
            "Варна": -18,
            "Каварна": -19
        };

        // Mapping for Hijri month names to Bulgarian, exactly as provided by the user
        const hijriMonthsBg = {
            "Muharram": "Мухаррем",
            "Safar": "Сафер",
            "Rabi' al-Awwal": "Рабиюлеввел",
            "Rabi' al-Thani": "Рабиюлахир",
            "Jumada al-Awwal": "Джемазиюлеввел",
            "Jumada al-Thani": "Джемазиюлахир",
            "Rajab": "Реджеб",
            "Sha'ban": "Шабан",
            "Ramadan": "Рамазан",
            "Shawwal": "Шеввал",
            "Dhul-Qadah": "Зилкаде",
            "Dhul-Hijjah": "Зилхидже"
        };


        let prayerTimes = {}; // Stores fetched prayer times (after all adjustments for selected city)
        let nextPrayerIndex = -1; // Index of the next prayer in the list
        let selectedCity = "София"; // Default selected city
        let currentHijriDate = ''; // To store and display Hijri date
        let selectedDate = new Date(); // Stores the currently selected date (defaults to today)
        let customPrayerAdjustments = {}; // Stores user-defined adjustments for each prayer {Fajr: 5, Dhuhr: -2}
        let currentAdjustingPrayer = null; // To keep track of which prayer is being adjusted in the modal

        // Populate city dropdown
        function populateCitySelect() {
            const sortedCities = Object.keys(cityOffsets).sort((a, b) => {
                if (a === "София") return -1;
                if (b === "София") return 1;
                return a.localeCompare(b);
            });

            sortedCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelectEl.appendChild(option);
            });
            citySelectEl.value = selectedCity;
        }

        // Function to format time to HH:MM
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Function to format date to DD.MM.YYYY
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Function to format date to YYYY-MM-DD for input type="date" and offline data lookup
        function formatDateForInputAndLookup(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to get day of the week in Bulgarian
        function getDayNameBg(date) {
            const days = ['Неделя', 'Понеделник', 'Вторник', 'Сряда', 'Четвъртък', 'Петък', 'Събота'];
            return days[date.getDay()];
        }

        // Function to determine Dhuhr name based on day of the week
        function getDhuhrName(date) {
            return date.getDay() === 5 ? 'Джума' : 'Обедна'; // Friday is 5
        }

        // Function to update the current time display
        function updateClock() {
            const now = new Date();
            currentTimeEl.textContent = formatTime(now);
        }

        // Function to fetch prayer times from OFFLINE DATA (always Sofia's base data)
        async function fetchPrayerTimes() {
            loadingIndicatorEl.classList.remove('hidden');
            errorMessageEl.classList.add('hidden'); 
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            const dateKey = formatDateForInputAndLookup(selectedDate);

            // Update Gregorian date and day display
            currentDateEl.textContent = formatDate(selectedDate);
            currentDayEl.textContent = getDayNameBg(selectedDate);

            // --- OFFLINE LOGIC START ---
            // Always try to get base times for Sofia
            const sofiaBaseData = offlinePrayerDataSofia[dateKey];

            if (sofiaBaseData) {
                // Apply general prayer-specific adjustments to Sofia's base times first
                // Then apply city-specific offset for the selected city
                const currentCityCustomOffset = cityOffsets[selectedCity] || 0;

                const adjustedPrayerTimes = {};
                for (const key in sofiaBaseData) {
                    if (sofiaBaseData.hasOwnProperty(key) && key !== 'hijri') {
                        let [hour, minute] = sofiaBaseData[key].split(':').map(Number);
                        let tempDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hour, minute, 0);

                        // Apply general prayer-specific adjustment
                        if (adjustments[key] !== undefined) { 
                            tempDate.setMinutes(tempDate.getMinutes() + adjustments[key]);
                        }
                        // Apply city-specific custom offset
                        tempDate.setMinutes(tempDate.getMinutes() + currentCityCustomOffset);

                        // *** Apply custom user adjustment (if exists for this prayer) ***
                        if (customPrayerAdjustments[key] !== undefined) {
                            tempDate.setMinutes(tempDate.getMinutes() + customPrayerAdjustments[key]);
                        }

                        adjustedPrayerTimes[key] = formatTime(tempDate);
                    }
                }
                
                prayerTimes = adjustedPrayerTimes; // Store the fully adjusted times

                // Use Hijri date from Sofia's base data
                const hijri = sofiaBaseData.hijri;
                if (hijri && hijri.month && hijri.month.en) {
                    const hijriDay = hijri.day;
                    const hijriMonthEnglish = hijri.month.en;
                    const hijriYear = hijri.year;
                    const hijriMonthBg = hijriMonthsBg[hijriMonthEnglish] || hijriMonthEnglish; 
                    currentHijriDate = `${hijriDay} ${hijriMonthBg} ${hijriYear} г.`; 
                    hijriDateEl.textContent = currentHijriDate;
                } else {
                    hijriDateEl.textContent = 'Хиджра дата не е налична'; 
                }

                displayPrayerTimes(); // Display times based on the fully adjusted 'prayerTimes'
                loadingIndicatorEl.classList.add('hidden');
            } else {
                // Data not found locally for Sofia for the selected date
                console.error('Prayer times data not found for Sofia for the selected date. Please ensure offlinePrayerDataSofia is populated for this date.');
                errorMessageEl.classList.remove('hidden');
                errorMessageEl.textContent = 'Няма налични данни за избраната дата. Моля, изберете друга дата или актуализирайте приложението.';
                loadingIndicatorEl.classList.add('hidden');
            }
            // --- OFFLINE LOGIC END ---
        }

        // Function to display prayer times in the list
        function displayPrayerTimes() {
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            const now = new Date(); // Keep current time for clock display
            const targetDate = selectedDate; // Use selectedDate for prayer time calculations
            
            let prayersArray = [];
            for (const key in prayerTimes) {
                if (prayerTimes.hasOwnProperty(key)) {
                    const [hour, minute] = prayerTimes[key].split(':').map(Number);
                    let prayerDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), hour, minute, 0);

                    let displayName = prayerNamesBg[key] || key;
                    if (key === 'Dhuhr') {
                        displayName = getDhuhrName(targetDate);
                    }

                    prayersArray.push({
                        name: key, // Original key for internal logic
                        displayName: displayName, // Name to display
                        time: formatTime(prayerDate), // Format adjusted time
                        date: prayerDate
                    });
                }
            }

            // Sort prayers by time to ensure correct order
            prayersArray.sort((a, b) => a.date.getTime() - b.date.getTime());

            // Find the next prayer only if the selected date is today
            if (selectedDate.toDateString() === new Date().toDateString()) {
                nextPrayerIndex = -1;
                for (let i = 0; i < prayersArray.length; i++) {
                    if (prayersArray[i].date > now) { // Compare with actual current time
                        nextPrayerIndex = i;
                        break;
                    }
                }
                if (nextPrayerIndex === -1 && prayersArray.length > 0) {
                    nextPrayerIndex = 0; // Set to Fajr for countdown, but indicate it's for tomorrow
                }
            } else {
                nextPrayerIndex = -1; // No "next prayer" highlight or countdown for past/future dates
            }


            // Render prayer times
            prayersArray.forEach((prayer, index) => {
                const prayerRow = document.createElement('div');
                prayerRow.className = 'prayer-row';

                // Highlight the current/next prayer only if today's date is selected
                if (selectedDate.toDateString() === new Date().toDateString() && index === nextPrayerIndex) {
                    prayerRow.classList.add('highlighted-prayer');
                }

                prayerRow.innerHTML = `
                    <span class="prayer-name">${prayer.displayName}</span>
                    <div class="flex items-center"> <!-- Group time and button together -->
                        <span class="prayer-time">${prayer.time}</span>
                        <button class="adjust-prayer-btn text-gray-500 hover:text-green-400 text-lg ml-2" data-prayer-name="${prayer.name}">⚙️</button>
                    </div>
                `;
                prayerTimesListEl.appendChild(prayerRow);
            });

            // Add event listener for the adjustment buttons using delegation
            // This ensures listeners work even if prayer rows are re-rendered
            prayerTimesListEl.querySelectorAll('.adjust-prayer-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const prayerName = event.currentTarget.dataset.prayerName;
                    openAdjustmentModal(prayerName);
                });
            });

            updateCountdown(); // Start/update countdown after displaying times
        }

        // Function to update the countdown to the next prayer
        function updateCountdown() {
            if (Object.keys(prayerTimes).length === 0 || selectedDate.toDateString() !== new Date().toDateString()) {
                countdownEl.textContent = '--:--:--';
                countdownTextEl.textContent = 'Няма отброяване за избраната дата.';
                return;
            }

            const now = new Date();
            let nextPrayerTimeDate;
            let nextPrayerDisplayName;

            // Recalculate prayersArray with ALL current adjustments for countdown
            let prayersArrayForCountdown = [];
            const currentCityCustomOffset = cityOffsets[selectedCity] || 0;
            const dateKey = formatDateForInputAndLookup(selectedDate);
            const sofiaBaseData = offlinePrayerDataSofia[dateKey]; // Get base data for selected date

            if (!sofiaBaseData) { // If no base data, can't calculate countdown
                countdownEl.textContent = '--:--:--';
                countdownTextEl.textContent = 'Няма налични данни за избраната дата.';
                return;
            }

            for (const key in sofiaBaseData) {
                if (sofiaBaseData.hasOwnProperty(key) && key !== 'hijri') {
                    const [hour, minute] = sofiaBaseData[key].split(':').map(Number);
                    let prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);

                    // Apply general prayer-specific adjustments
                    if (adjustments[key] !== undefined) {
                        prayerDate.setMinutes(prayerDate.getMinutes() + adjustments[key]);
                    }
                    // Apply city-specific custom offset
                    prayerDate.setMinutes(prayerDate.getMinutes() + currentCityCustomOffset);

                    // Apply custom user adjustment
                    if (customPrayerAdjustments[key] !== undefined) {
                        prayerDate.setMinutes(prayerDate.getMinutes() + customPrayerAdjustments[key]);
                    }

                    let displayName = prayerNamesBg[key] || key;
                    if (key === 'Dhuhr') {
                        displayName = getDhuhrName(now);
                    }

                    prayersArrayForCountdown.push({
                        name: key,
                        displayName: displayName,
                        time: formatTime(prayerDate),
                        date: prayerDate
                    });
                }
            }
            prayersArrayForCountdown.sort((a, b) => a.date.getTime() - b.date.getTime());

            // Find next prayer for countdown
            nextPrayerIndex = -1; // Reset for countdown logic
            for (let i = 0; i < prayersArrayForCountdown.length; i++) {
                if (prayersArrayForCountdown[i].date > now) {
                    nextPrayerIndex = i;
                    break;
                }
            }
            // If all prayers for today have passed, set countdown to Fajr of next day
            if (nextPrayerIndex === -1 && prayersArrayForCountdown.length > 0) {
                nextPrayerIndex = 0; // Next prayer is Fajr of next day
                const nextDayFajr = new Date(prayersArrayForCountdown[0].date);
                nextDayFajr.setDate(nextDayFajr.getDate() + 1);
                nextPrayerTimeDate = nextDayFajr;
                nextPrayerDisplayName = prayersArrayForCountdown[0].displayName;
                countdownTextEl.textContent = `до ${nextPrayerDisplayName} утре`;
            } else if (nextPrayerIndex !== -1) {
                const nextPrayer = prayersArrayForCountdown[nextPrayerIndex];
                nextPrayerTimeDate = nextPrayer.date;
                nextPrayerDisplayName = nextPrayer.displayName;
                countdownTextEl.textContent = `до ${nextPrayerDisplayName}`;
            } else {
                // Should not happen if prayersArrayForCountdown is populated, but as a fallback
                countdownEl.textContent = '00:00:00';
                countdownTextEl.textContent = 'Всички намази за днес са минали.';
                return;
            }

            const diff = nextPrayerTimeDate.getTime() - now.getTime();

            if (diff <= 0) {
                countdownEl.textContent = '00:00:00';
                countdownTextEl.textContent = 'Намазът е сега!';
                fetchPrayerTimes(); // Re-fetch to update for the next day/prayer
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Function to fetch prayer times for the next day (called when all prayers for today have passed)
        function fetchPrayerTimesForNextDay() {
            const tomorrow = new Date(selectedDate);
            tomorrow.setDate(tomorrow.getDate() + 1);
            selectedDate = tomorrow; // Update selectedDate to tomorrow
            datePickerEl.value = formatDateForInputAndLookup(selectedDate); // Update date picker
            fetchPrayerTimes(); // Fetch times for the new selectedDate
        }

        // --- Modal Logic ---
        function openAdjustmentModal(prayerName) {
            currentAdjustingPrayer = prayerName;
            modalPrayerNameEl.textContent = `Корекция за ${prayerNamesBg[prayerName] || prayerName}`;
            
            // Populate input with current custom adjustment for this prayer, default to 0
            adjustedMinutesOffsetInput.value = customPrayerAdjustments[prayerName] !== undefined ? customPrayerAdjustments[prayerName] : 0;
            
            adjustmentModal.classList.remove('hidden');
        }

        function closeAdjustmentModal() {
            adjustmentModal.classList.add('hidden');
            currentAdjustingPrayer = null;
            errorMessageEl.classList.add('hidden'); // Clear error message when closing modal
        }

        function saveIndividualAdjustment() {
            if (!currentAdjustingPrayer) return;

            const newOffset = parseInt(adjustedMinutesOffsetInput.value, 10);

            if (isNaN(newOffset)) {
                 errorMessageEl.textContent = 'Моля, въведете валидно число за корекция (напр. 5 или -3).';
                 errorMessageEl.classList.remove('hidden');
                 return;
            }
            errorMessageEl.classList.add('hidden'); // Clear error if input is valid

            customPrayerAdjustments[currentAdjustingPrayer] = newOffset;
            saveSettings(); // Save all settings including new custom adjustment
            fetchPrayerTimes(); // Re-fetch and display with new custom adjustment
            closeAdjustmentModal();
        }

        // --- Local Storage Functions ---
        function saveSettings() {
            const settingsToSave = {
                selectedCity: selectedCity,
                selectedDate: formatDateForInputAndLookup(selectedDate), // Save as string
                customPrayerAdjustments: customPrayerAdjustments
            };
            try {
                localStorage.setItem('prayerApp_settings', JSON.stringify(settingsToSave));
                // Optionally provide user feedback:
                // console.log("Настройките запазени успешно!");
            } catch (e) {
                console.error("Неуспешно запазване на настройките в localStorage:", e);
                errorMessageEl.textContent = 'Неуспешно запазване на настройките.';
                errorMessageEl.classList.remove('hidden');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('prayerApp_settings'));
                if (savedSettings) {
                    selectedCity = savedSettings.selectedCity || "София";
                    if (savedSettings.selectedDate) {
                        selectedDate = new Date(savedSettings.selectedDate);
                        // Ensure the date object is valid, fallback to today if not
                        if (isNaN(selectedDate.getTime())) {
                            selectedDate = new Date();
                        }
                    } else {
                        selectedDate = new Date(); // Default to today if not saved
                    }
                    customPrayerAdjustments = savedSettings.customPrayerAdjustments || {};
                    
                    // Update city select dropdown to reflect loaded city
                    citySelectEl.value = selectedCity;
                }
            } catch (e) {
                console.error("Неуспешно зареждане на настройките от localStorage:", e);
                errorMessageEl.textContent = 'Възникна проблем при зареждане на настройките. Използват се настройки по подразбиране.';
                errorMessageEl.classList.remove('hidden');
                // Optionally clear corrupted settings if needed: localStorage.removeItem('prayerApp_settings');
            }
        }

        // Initial setup and periodic updates
        window.onload = function() {
            populateCitySelect();
            loadSettings(); // Load settings first
            
            // Set date picker value based on loaded/default selectedDate
            datePickerEl.value = formatDateForInputAndLookup(selectedDate);
            
            updateClock(); // Start current time display
            fetchPrayerTimes(); // Initial fetch of prayer times using loaded settings

            // Event listener for city selection change
            citySelectEl.addEventListener('change', (event) => {
                selectedCity = event.target.value;
                fetchPrayerTimes(); // Re-fetch times for the new city
            });

            // Event listener for date picker change
            datePickerEl.addEventListener('change', (event) => {
                selectedDate = new Date(event.target.value);
                fetchPrayerTimes(); // Re-fetch times for the newly selected date
            });

            // Event listener for the main "Save Settings" button
            saveSettingsBtn.addEventListener('click', saveSettings);

            // Event listeners for modal buttons
            cancelAdjustmentBtn.addEventListener('click', closeAdjustmentModal);
            saveAdjustmentBtn.addEventListener('click', saveIndividualAdjustment);

            // Update clock every second
            setInterval(updateClock, 1000);
            // Update countdown every second (only active for today's date)
            setInterval(updateCountdown, 1000);
        };
    </script>
</body>
</html>
