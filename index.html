<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Времена за Намаз</title>
    <!-- Web icon (favicon) updated to reference a static file for better compatibility on hosting platforms like GitHub Pages. -->
    <!-- Please ensure you have a 'favicon.png' file in the root directory of your project. -->
    <link rel="icon" href="/favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #3b82f6); /* Жив, градиентен фон */
            color: #e2e8f0; /* Светъл цвят на текста */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0.5rem;
            box-sizing: border-box;
            overflow: hidden; /* Предотвратява хоризонтално превъртане */
        }
        .container {
            background-color: rgba(45, 55, 72, 0.6); /* Полупрозрачен фон */
            backdrop-filter: blur(15px) saturate(180%); /* Ефект на замъгляване/стъкло */
            -webkit-backdrop-filter: blur(15px) saturate(180%); /* За WebKit браузъри */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Лека бяла рамка */
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5), /* Мека, голяма сянка */
                        inset 0 0 0 1px rgba(255, 255, 255, 0.05); /* Лека вътрешна рамка */
            border-radius: 2rem; /* По-заоблени ъгли */
            padding: 1.5rem; /* Повече padding */
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Повече разстояние */
            box-sizing: border-box;
        }
        /* Responsive max-width for larger screens */
        @media (min-width: 768px) { /* md breakpoint */
            .container {
                max-width: 640px; /* md:max-w-xl */
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .container {
                max-width: 768px; /* lg:max-w-2xl */
            }
        }

        /* Responsive text sizes for countdown */
        #countdown {
            font-weight: 800; /* По-дълбок шрифт */
            color: #ffffff; /* По-бял цвят */
            text-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(104, 211, 145, 0.5); /* Мека сияйна сянка */
            transition: all 0.3s ease-in-out;
        }
        #countdown:hover {
            transform: scale(1.05); /* Ефект при ховър */
        }


        .countdown-text {
            font-size: 1.2rem; /* Леко по-голям */
            font-weight: 500;
            color: #d1d8e0; /* По-светло сиво */
            margin-top: 0.5rem; /* Увеличен margin */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        .prayer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem; /* По-голям padding */
            border-bottom: 1px solid rgba(74, 85, 104, 0.5); /* По-мек разделител */
            background-color: rgba(0, 0, 0, 0.1); /* Много леко прозрачен фон */
            border-radius: 0.75rem; /* Заоблени ъгли */
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .prayer-row:hover {
            background-color: rgba(0, 0, 0, 0.2); /* По-тъмен фон при ховър */
            box-shadow: inset  0 0 5px rgba(255, 255, 255, 0.1); /* Лека вътрешна сянка при ховър */
        }
        .prayer-row:last-child {
            border-bottom: none;
        }
        .prayer-name {
            font-size: 1.1rem; /* Леко по-голям */
            font-weight: 600;
            color: #e2e8f0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        .prayer-time {
            font-size: 1.2rem; /* Леко по-голям */
            font-weight: 700;
            color: #a0aec0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        .highlighted-prayer {
            background: linear-gradient(135deg, rgba(104, 211, 145, 0.4), rgba(56, 178, 172, 0.4)); /* Ярък, прозрачен градиент */
            box-shadow: 0 0 15px rgba(104, 211, 145, 0.7); /* Сияйна сянка */
            border: 1px solid #68d391; /* По-отличителна рамка */
        }
        .highlighted-prayer .prayer-name,
        .highlighted-prayer .prayer-time {
            color: #ffffff; /* Бял текст за подчертаните елементи */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #68d391;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* General button style for action buttons (date, language, adjustments) */
        .action-button {
            background: linear-gradient(145deg, #4a5568, #2d3748); /* Градиентен фон */
            color: #e2e8f0;
            border: 1px solid rgba(104, 211, 145, 0.5); /* Полупрозрачна рамка */
            border-radius: 1rem; /* По-заоблени ъгли */
            padding: 0.75rem; /* По-голям padding */
            width: 3.5rem; /* Леко увеличен размер */
            height: 3.5rem; /* Леко увеличен размер */
            font-size: 1.8rem; /* По-голям емотикон */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4), /* Мека сянка */
                        inset 0 0 10px rgba(255, 255, 255, 0.2); /* Вътрешен блясък */
        }
        .action-button:hover {
            background: linear-gradient(145deg, #5a677d, #3e4c61); /* По-тъмен градиент при ховър */
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px); /* Леко повдигане */
        }
        .action-button:active {
            transform: translateY(0); /* Връщане при натискане */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5); /* Ефект на натискане */
        }
        .action-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(104, 211, 145, 0.6); /* Ярък фокус */
        }
        /* Specific style for adjustment button that contains text */
        #open-adjustment-modal-btn {
            border-radius: 1.75rem; /* По-кръгъл за този бутон */
        }
        #return-today-btn {
            border-radius: 100%; /* Напълно кръгъл */
        }


        /* Hidden input for date selection */
        .hidden-date-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* По-тъмен прозрачен фон */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 0.5rem;
            backdrop-filter: blur(10px) brightness(80%); /* Замъгляване и потъмняване на фона */
            -webkit-backdrop-filter: blur(10px) brightness(80%);
        }
        .modal-content {
            background-color: rgba(45, 55, 72, 0.8); /* Полупрозрачен фон за модала */
            backdrop-filter: blur(20px) saturate(150%); /* По-силно замъгляване за модала */
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.3); /* По-ясна рамка */
            border-radius: 2rem;
            padding: 2rem; /* Повече padding */
            width: 100%;
            max-width: 450px; /* По-голяма максимална ширина */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            max-height: 90vh; /* По-голяма височина */
            overflow-y: auto;
        }
        .city-list-item {
            padding: 0.8rem 1.2rem; /* Повече padding */
            border-bottom: 1px solid rgba(74, 85, 104, 0.6); /* По-отчетлив разделител */
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out;
            border-radius: 0.5rem;
        }
        .city-list-item:hover {
            background-color: rgba(58, 71, 93, 0.7); /* По-тъмен полупрозрачен фон */
            transform: translateX(5px); /* Леко приплъзване при ховър */
        }
        .city-list-item.selected {
            background: linear-gradient(90deg, #68d391, #38b2ac); /* Зелен градиент */
            color: #1a202c;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(104, 211, 145, 0.5); /* Сияние */
        }
        .city-list-item:last-child {
            border-bottom: none;
        }

        /* Styles for the new adjustment modal inputs */
        .adjustment-input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem; /* Повече margin */
        }
        .adjustment-input-row label {
            font-size: 1.05rem; /* Леко по-голям */
            font-weight: 500;
            color: #cbd5e0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        .adjustment-input-row input[type="number"] {
            width: 80px; /* По-широк input */
            text-align: center;
            background-color: rgba(74, 85, 104, 0.7); /* Полупрозрачен фон */
            border: 1px solid rgba(104, 211, 145, 0.6); /* Полупрозрачна рамка */
            color: #e2e8f0;
            border-radius: 0.5rem; /* По-заоблени ъгли */
            padding: 0.4rem 0.6rem; /* Повече padding */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5); /* Вътрешна сянка */
            transition: all 0.2s ease-in-out;
        }
        .adjustment-input-row input[type="number"]:focus {
            background-color: rgba(74, 85, 104, 0.9);
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.7), 0 0 0 3px rgba(104, 211, 145, 0.5);
        }
        .modal-content button {
            padding: 0.75rem 1.5rem; /* По-голям padding за бутоните в модала */
            border-radius: 0.75rem; /* По-заоблени ъгли */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .modal-content button:hover {
            transform: translateY(-1px);
        }
        /* Styling for the new button group in sacred events view */
        .sacred-events-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem; /* Increased margin */
        }
        /* Custom styles for the scrollable list container */
        #sacred-events-list-container {
            max-height: 400px; /* Adjust as needed for desired height, e.g., 96 Tailwind units */
            overflow-y: auto;
            border-radius: 1rem; /* Rounded corners for the scrollable area */
            background-color: rgba(0, 0, 0, 0.1); /* Very subtle background for the scroll area */
            padding: 0.5rem; /* Padding inside scroll area */
            border: 1px solid rgba(255, 255, 255, 0.05); /* Very subtle inner border */
        }
        /* Style for the scrollbar to make it less intrusive */
        #sacred-events-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #sacred-events-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        #sacred-events-list-container::-webkit-scrollbar-thumb {
            background: rgba(104, 211, 145, 0.5);
            border-radius: 10px;
        }
        #sacred-events-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(104, 211, 145, 0.7);
        }

        /* --- BRIGHTER TEXT STYLES --- */
        #current-date,
        #current-day,
        #current-time,
        #selected-city-display,
        #hijri-date {
            color: #ffffff; /* White color for Gregorian date, day, time, and location */
            font-weight: 600; /* Make them a bit bolder */
            text-shadow: 0 0 5px rgba(255,255,255,0.4); /* Subtle glow */
        }
        #sacred-day-info {
            color: #98fb98; /* PaleGreen for sacred day/night */
            font-weight: 700; /* Extra bold */
            text-shadow: 0 0 8px rgba(152, 251, 152, 0.7); /* Stronger glow for sacred day */
            font-size: 0.95rem; /* Slightly larger for emphasis */
        }

    </style>
</head>
<body class="antialiased">
    <div class="container">
        <!-- Top row: Gregorian Date & Day + Current Time (left), Hijri Date & Sacred Day + Location (right) -->
        <div class="flex justify-between items-start text-sm md:text-base">
            <div id="gregorian-date-info" class="flex flex-col items-start font-medium">
                <span id="current-date"></span>
                <span id="current-day"></span>
                <div id="current-time" class="text-xl font-semibold mt-1"></div>
            </div>
            <div id="hijri-and-sacred-info" class="flex flex-col items-end">
                <span id="hijri-date"></span>
                <span id="sacred-day-info" class="font-semibold text-sm mt-1"></span>
                <span id="selected-city-display" class="text-sm mt-1">София</span>
            </div>
        </div>

        <!-- Prayer Times View -->
        <div id="prayer-times-view">
            <div class="text-center flex flex-col items-center">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <div id="countdown" class="text-5xl md:text-6xl lg:text-7xl">--:--:--</div>
                    <button id="return-today-btn" class="action-button !w-12 !h-12 !text-2xl hidden">🔄</button>
                </div>
                <div id="countdown-text" class="countdown-text">зареждане...</div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center items-center py-4 hidden">
                <div class="loading-spinner"></div>
            </div>

            <div id="prayer-times-list" class="flex flex-col gap-2">
                <!-- Prayer times will be populated here -->
            </div>

            <div id="error-message" class="hidden text-center text-red-400 text-sm mt-2">
                Възникна грешка при зареждане на времената за намаз. Моля, опитайте отново по-късно.
            </div>
        </div>

        <!-- Sacred Events View (Initially Hidden) -->
        <div id="sacred-events-view" class="hidden">
            <div class="text-center flex flex-col items-center">
                <h3 class="text-xl font-semibold text-white mb-4">Свещени дни и нощи за 2025 г.</h3>
                <!-- NEW: Main countdown for Sacred Events -->
                <div class="flex flex-col items-center justify-center gap-1 mb-4">
                    <div id="sacred-countdown-display" class="text-5xl md:text-6xl lg:text-7xl">-- дни --</div>
                    <div id="sacred-countdown-text" class="countdown-text">зареждане...</div>
                </div>

                <!-- NEW: Button group for sacred events view -->
                <div class="sacred-events-controls">
                    <button id="back-to-prayer-times-btn" class="action-button !w-12 !h-12 !text-2xl">↩️</button>
                    <button id="toggle-sacred-events-countdown-btn" class="action-button !w-12 !h-12 !text-2xl">⏳</button>
                </div>
            </div>
            <div id="sacred-events-loading-indicator" class="flex justify-center items-center py-4 hidden">
                <div class="loading-spinner"></div>
            </div>
            <div id="sacred-events-list-container" class="max-h-96 overflow-y-auto mb-4">
                <div id="sacred-events-list" class="flex flex-col gap-1">
                    <!-- Sacred events will be populated here -->
                </div>
            </div>
        </div>

        <!-- New bottom row for action buttons (dynamically hidden/shown) -->
        <div id="main-action-buttons" class="flex justify-center md:justify-around items-center mt-4 gap-4">
            <!-- Location Button (emoji only, opens modal) -->
            <button id="location-select-btn" class="action-button">📍</button>

            <!-- Sacred Events Toggle Button -->
            <button id="open-sacred-events-toggle-btn" class="action-button">✨</button>

            <!-- NEW Countdown Toggle Button -->
            <button id="countdown-toggle-btn" class="action-button">⌛</button>

            <!-- Date Button (emoji only) -->
            <div class="relative">
                <button id="date-picker-btn" class="action-button">🗓️</button>
                <input type="date" id="hidden-date-input" class="hidden-date-input">
            </div>

            <!-- Language Toggle Button -->
            <button id="language-toggle-btn" class="action-button">💬</button>

            <!-- Adjustment Button -->
            <button id="open-adjustment-modal-btn" class="action-button">⚙️</button>
        </div>
    </div>

    <!-- City Selection Modal -->
    <div id="city-selection-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4">Изберете град</h3>
            <div id="city-list" class="flex flex-col gap-1 mb-4">
                <!-- City options will be populated here by JavaScript -->
            </div>
            <div class="flex justify-end">
                <button id="close-city-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">Затвори</button>
            </div>
        </div>
    </div>

    <!-- Global Prayer Adjustment Modal (reworked) -->
    <div id="adjustment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-white mb-4">Корекции на времена за намаз</h3>
            <p class="text-gray-300 text-sm mb-3">Въведете корекция в минути (+ за напред, - за назад):</p>
            <div id="prayer-adjustment-inputs" class="mb-4">
                <!-- Adjustment inputs will be dynamically generated here -->
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-adjustment-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">Отказ</button>
                <button id="save-all-adjustments-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">Запази</button>
            </div>
        </div>
    </div>

    <!-- Sacred Event Adjustment Modal (removed from HTML as per request) -->
    <script>
        // --- HARDCODED SACRED EVENTS DEFINITIONS FOR 2025 (КОРИГИРАНО И ДОПЪЛНЕНО СПОРЕД ДАННИТЕ НА ДИЯНЕТА) ---
        // These are Gregorian dates for sacred Islamic events as per Diyanet calendar for 2025.
        // The display names are in Bulgarian.
        const HARDCODED_SACRED_EVENTS_2025 = [
            // Month is 0-indexed (January is 0, February is 1, etc.)
            { nameBg: "Начало на Трите Месеца (1 Реджеб)", date: new Date(2025, 0, 1), key: "UcAylarinBaslangici_Jan" }, // 1 Януари 2025
            { nameBg: "Нощта на Регаиб (2 Реджеб)", date: new Date(2025, 0, 2), key: "Regaib" }, // 2 Януари 2025
            { nameBg: "Нощта на Мирадж (26 Реджеб)", date: new Date(2025, 0, 26), key: "Miraj" }, // 26 Януари 2025
            { nameBg: "Нощта на Берат (14 Шабан)", date: new Date(2025, 1, 13), key: "Berat" }, // 13 Февруари 2025
            { nameBg: "Начало на Рамазан (1 Рамазан)", date: new Date(2025, 2, 1), key: "RamadanStart" }, // 1 Март 2025
            { nameBg: "Нощта Кадир (26 Рамазан)", date: new Date(2025, 2, 26), key: "Kadir" }, // 26 Март 2025
            { nameBg: "Арефе (преди Рамазан Байрам)", date: new Date(2025, 2, 29), key: "RamazanArefe" }, // 29 Март 2025
            { nameBg: "Рамазан Байрам - Ден 1 (1 Шеввал)", date: new Date(2025, 2, 30), key: "RamazanBayram1" }, // 30 Март 2025
            { nameBg: "Рамазан Байрам - Ден 2 (2 Шеввал)", date: new Date(2025, 2, 31), key: "RamazanBayram2" }, // 31 Март 2025
            { nameBg: "Рамазан Байрам - Ден 3 (3 Шеввал)", date: new Date(2025, 3, 1), key: "RamazanBayram3" }, // 1 Април 2025
            { nameBg: "Денят Арафа (9 Зилхидже)", date: new Date(2025, 5, 5), key: "Arafa" }, // 5 Юни 2025
            { nameBg: "Курбан Байрам - Ден 1 (10 Зилхидже)", date: new Date(2025, 5, 6), key: "KurbanBayram1" }, // 6 Юни 2025
            { nameBg: "Курбан Байрам - Ден 2 (11 Зилхидже)", date: new Date(2025, 5, 7), key: "KurbanBayram2" }, // 7 Юни 2025
            { nameBg: "Курбан Байрам - Ден 3 (12 Зилхидже)", date: new Date(2025, 5, 8), key: "KurbanBayram3" }, // 8 Юни 2025
            { nameBg: "Курбан Байрам - Ден 4 (13 Зилхидже)", date: new Date(2025, 5, 9), key: "KurbanBayram4" }, // 9 Юни 2025
            { nameBg: "Нова Хиджri година (1 Мухаррем)", date: new Date(2025, 5, 26), key: "NewHijriYear" }, // 26 Юни 2025
            { nameBg: "Ашура (10 Мухаррем)", date: new Date(2025, 6, 5), key: "Ashura" }, // 5 Юли 2025
            { nameBg: "Мевлид Кандилли (11 Рабиюлеввел)", date: new Date(2025, 8, 3), key: "Mawlid" }, // 3 Септември 2025
            { nameBg: "Начало на Трите Месеца (1 Реджеб)", date: new Date(2025, 11, 21), key: "UcAylarinBaslangici_Dec" }, // 21 Декември 2025
            { nameBg: "Нощта на Регаиб (5 Реджеб)", date: new Date(2025, 11, 25), key: "Regaib_Dec" } // 25 Декември 2025
        ].sort((a, b) => a.date.getTime() - b.date.getTime()); // Sort by Gregorian date

        // --- END OF HARDCODED SACRED EVENTS DEFINITIONS ---


        // DOM Elements
        const currentTimeEl = document.getElementById('current-time');
        const countdownEl = document.getElementById('countdown');
        const countdownTextEl = document.getElementById('countdown-text');
        const currentDateEl = document.getElementById('current-date');
        const currentDayEl = document.getElementById('current-day');
        const hijriDateEl = document.getElementById('hijri-date');
        const sacredDayInfoEl = document.getElementById('sacred-day-info'); 
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const errorMessageEl = document.getElementById('error-message');
        const locationSelectBtn = document.getElementById('location-select-btn'); 
        const selectedCityDisplay = document.getElementById('selected-city-display'); 
        const datePickerBtn = document.getElementById('date-picker-btn'); 
        const hiddenDateInput = document.getElementById('hidden-date-input'); 
        const languageToggleBtn = document.getElementById('language-toggle-btn'); 
        const openAdjustmentModalBtn = document.getElementById('open-adjustment-modal-btn'); 
        const countdownToggleButton = document.getElementById('countdown-toggle-btn'); 
        const returnTodayBtn = document.getElementById('return-today-btn');

        // Modals and their elements
        const citySelectionModal = document.getElementById('city-selection-modal'); 
        const cityListEl = document.getElementById('city-list');
        const closeCityModalBtn = document.getElementById('close-city-modal-btn');

        const adjustmentModal = document.getElementById('adjustment-modal');
        const prayerAdjustmentInputsContainer = document.getElementById('prayer-adjustment-inputs'); 
        const cancelAdjustmentBtn = document.getElementById('cancel-adjustment-btn');
        const saveAllAdjustmentsBtn = document.getElementById('save-all-adjustments-btn'); 

        // Main Views
        const prayerTimesView = document.getElementById('prayer-times-view');
        const prayerTimesListEl = document.getElementById('prayer-times-list');
        const sacredEventsView = document.getElementById('sacred-events-view');
        const mainActionButtons = document.getElementById('main-action-buttons'); // Get the container for action buttons

        // Sacred Events View Elements
        const openSacredEventsToggleBtn = document.getElementById('open-sacred-events-toggle-btn');
        const toggleSacredEventsCountdownBtn = document.getElementById('toggle-sacred-events-countdown-btn');
        const sacredEventsListEl = document.getElementById('sacred-events-list');
        const sacredEventsLoadingIndicator = document.getElementById('sacred-events-loading-indicator');
        const backToPrayerTimesBtn = document.getElementById('back-to-prayer-times-btn');

        // NEW: Sacred Events Main Countdown Elements
        const sacredCountdownDisplay = document.getElementById('sacred-countdown-display');
        const sacredCountdownText = document.getElementById('sacred-countdown-text');
        const sacredEventsListContainer = document.getElementById('sacred-events-list-container');


        // Prayer names in Bulgarian (Dhuhr will be handled conditionally)
        const prayerNamesStandard = {
            Fajr: 'Зора',
            Sunrise: 'Изгрев',
            Dhuhr: 'Обедна', 
            Asr: 'Следобедна',
            Maghrib: 'Вечерна',
            Isha: 'Нощна'
        };

        const prayerNamesClassical = {
            Fajr: 'Заговеване', 
            Sunrise: 'Изгиране', 
            Dhuhr: 'Пладен', 
            Asr: 'Икиндие', 
            Maghrib: 'Ашем', 
            Isha: 'Йецие' 
        };

        // All prayer keys for iteration
        const allPrayerKeys = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

        // General prayer-specific adjustments in minutes (applied on top of base times)
        const adjustments = {
            Fajr: 0,
            Sunrise: -7,
            Dhuhr: 5,
            Asr: 4,
            Maghrib: 6,
            Isha: 0 
        };

        // Custom city offsets relative to Sofia (minutes to be added/subtracted from Sofia's times)
        const cityOffsets = {
            "София": 0, // Base city, no offset
            "Гоце Делчев": -1,
            "Якоруда": -1,
            "Велинград": -3,
            "Кнежа": -3,
            "Ловеч": -5,
            "Смолян": -5,
            "Пловдив": -5,
            "Плевен": -5,
            "Мадан": -6,
            "Никопол": -6,
            "Карлово": -6,
            "Свищов": -8,
            "Кърджали": -8,
            "Крумовград": -9,
            "Велико Търново": -9,
            "Стара Загора": -9,
            "Хасково": -9,
            "Горна Оряховица": -9,
            "Русе": -10,
            "Твърдица": -10,
            "Харманли": -10,
            "Нова Загора": -10,
            "Кубрат": -12,
            "Разград": -12,
            "Котел": -12,
            "Сливен": -12,
            "Ямбол": -12,
            "Исперих": -13,
            "Велики Преслав": -13,
            "Търговище": -13,
            "Ситово": -14,
            "Каолиново": -14,
            "Карнобат": -14,
            "Шумен": -14,
            "Нови Пазар": -15,
            "Айтос": -15,
            "Провадия": -16,
            "Бургас": -16,
            "Силистра": -16,
            "Добрич": -17,
            "Бяла": -17,
            "Балчик": -18,
            "Варна": -18,
            "Каварна": -19
        };

        // Mapping for Hijri month names to Bulgarian (still used for Hijri date display)
        const hijriMonthsBg = {
            "Muharram": "Мухаррем",
            "Safar": "Сафер",
            "Rabi' al-Awwal": "Рабиюлеввел",
            "Rabi' al-Thani": "Рабиюлахир",
            "Jumada al-Awwal": "Джемазиюлеввел",
            "Jumada al-Thani": "Джемазиюлахир",
            "Rajab": "Реджеб",
            "Sha'ban": "Шабан",
            "Ramadan": "Рамазан",
            "Shawwal": "Шеввал",
            "Dhul-Qadah": "Зилкаде",
            "Dhul-Hijjah": "Зилхидже"
        };

        let prayerTimes = {}; 
        let nextPrayerIndex = -1;
        let selectedCity = "София";
        let currentHijriDate = '';
        let selectedDate = new Date();
        let customPrayerAdjustments = {};
        let isClassicalNamesActive = false;
        let isCountdownMode = false;

        let isSacredEventsCountdownMode = false; // Toggle for countdown/date display in sacred events view

        let individualCountdownIntervalId = null;
        let prayersDataForDisplay = []; 
        let eventsToToogleDisplay = []; // Now populated directly from HARDCODED_SACRED_EVENTS_2025
        let sacredEventsCountdownIntervalId = null; // for individual sacred event list countdown
        let sacredEventsMainCountdownIntervalId = null; // NEW: for main sacred events countdown


        // Get current prayer names based on state
        function getCurrentPrayerNames() {
            return isClassicalNamesActive ? prayerNamesClassical : prayerNamesStandard;
        }

        // Populate city list in modal
        function populateCityList() {
            cityListEl.innerHTML = '';
            const sortedCities = Object.keys(cityOffsets).sort((a, b) => {
                if (a === "София") return -1;
                if (b === "София") return 1;
                return a.localeCompare(b);
            });

            sortedCities.forEach(city => {
                const cityItem = document.createElement('div');
                cityItem.className = 'city-list-item';
                if (city === selectedCity) {
                    cityItem.classList.add('selected');
                }
                cityItem.textContent = city;
                cityItem.dataset.city = city;
                cityItem.addEventListener('click', () => {
                    selectedCity = city;
                    selectedCityDisplay.textContent = selectedCity;
                    closeCitySelectionModal();
                    fetchPrayerTimes();
                    saveSettings();
                });
                cityListEl.appendChild(cityItem);
            });
        }

        // Function to format time to HH:MM
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Function to format duration (for countdown mode in list for prayer times)
        function formatDuration(milliseconds) {
            let prefix = '';
            if (milliseconds < 0) {
                prefix = '-';
                milliseconds = Math.abs(milliseconds);
            }

            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            let timeParts = [];
            timeParts.push(`${String(hours).padStart(2, '0')}ч`);
            timeParts.push(`${String(minutes).padStart(2, '0')}м`);
            timeParts.push(`${String(seconds).padStart(2, '0')}с`);

            let timeDisplay = timeParts.join(' ');
            
            return prefix + timeDisplay.trim(); 
        }

        // UPDATED: Function to format duration for sacred events in days (or "преди X дни")
        function formatSacredEventDisplay(eventDate) {
            const now = new Date();
            // Normalize 'now' and 'eventDate' to start of their respective days for accurate day difference
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfEventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
            
            const diffMs = startOfEventDay.getTime() - startOfToday.getTime();
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24)); // Round for closest day, not ceil

            if (diffDays === 0) {
                return "днес"; // Event is today
            } else if (diffDays === 1) {
                return "утре"; // Event is tomorrow
            } else if (diffDays > 1) {
                return `след ${diffDays} дни`; // Event is in X days
            } else { // diffDays < 0 (event is in the past)
                const daysAgo = Math.abs(diffDays);
                return `преди ${daysAgo} дни`; // Event was X days ago
            }
        }


        // Function to format date to DD.MM.YYYY
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Function to format date to WHICH-MM-DD for input type="date" and API calls
        function formatDateForInputAndLookup(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to get day of the week in Bulgarian
        function getDayNameBg(date) {
            const days = ['Неделя', 'Понеделник', 'Вторник', 'Сряда', 'Четвъртък', 'Петък', 'Събота'];
            return days[date.getDay()];
        }

        // Function to determine Dhuhr name based on day of the week and current naming style
        function getDhuhrName(date) {
            if (date.getDay() === 5) { // Friday
                return isClassicalNamesActive ? "Джумайо" : "Джума"; 
            }
            return isClassicalNamesActive ? "Пладен" : "Обедна";
        }

        // Function to update the current time display
        function updateClock() {
            const now = new Date();
            currentTimeEl.textContent = formatTime(now);
        }

        // Function to fetch Hijri date for a given Gregorian date using Aladhan API
        // This is primarily used for the top display of current Hijri date.
        async function getHijriDateForGregorian(year, month, day) {
            const gregorianDate = `${String(day).padStart(2, '0')}-${String(month).padStart(2, '0')}-${year}`;
            const apiUrl = `https://api.aladhan.com/v1/timingsByCity/${gregorianDate}?city=Sofia&country=Bulgaria&method=10`; // Using Sofia for conversion base

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error(`HTTP error fetching Hijri date: Status ${response.status} for ${gregorianDate}`);
                    return null;
                }
                const data = await response.json();
                if (data.data && data.data.date && data.data.date.hijri) {
                    return data.data.date.hijri; // Returns an object like { day: "1", month: { en: "Ramadan" }, year: "1446" }
                } else {
                    console.warn("Could not retrieve Hijri date data from API for", gregorianDate, ". Response:", data);
                    return null;
                }
            } catch (error) {
                console.error("Error fetching Hijri date (network/CORS issue likely):", error);
                return null;
            }
        }
        
        // Function to fetch prayer times from API
        async function fetchPrayerTimes() {
            // Show loading indicator
            loadingIndicatorEl.classList.remove('hidden');
            errorMessageEl.classList.add('hidden'); 
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            // Clear any running individual countdowns before fetching new data
            clearInterval(individualCountdownIntervalId);
            individualCountdownIntervalId = null;

            const currentDateStringForAPI = `${String(selectedDate.getDate()).padStart(2, '0')}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${selectedDate.getFullYear()}`;

            // Update Gregorian date and day display
            currentDateEl.textContent = formatDate(selectedDate);
            currentDayEl.textContent = getDayNameBg(selectedDate);
            selectedCityDisplay.textContent = selectedCity; // Update the selected city display

            // Fetch base times for Sofia using Diyanet method (method=10)
            const diyanetApiUrl = `https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=10`;
            
            // Fetch Isha time specifically using Muslim World League method (method=3)
            const mwlIshaApiUrl = `https://api.aladhan.com/v1/timingsByCity/${currentDateStringForAPI}?city=Sofia&country=Bulgaria&method=3`;

            try {
                const [diyanetResponse, mwlIshaResponse] = await Promise.all([
                    fetch(diyanetApiUrl),
                    fetch(mwlIshaApiUrl)
                ]);

                if (!diyanetResponse.ok || !mwlIshaResponse.ok) {
                    throw new Error(`HTTP error! Statuses: Diyanet ${diyanetResponse.status}, MWL ${mwlIshaResponse.status}`);
                }

                const diyanetData = await diyanetResponse.json();
                const mwlIshaData = await mwlIshaResponse.json();

                // Check for essential data for prayer times calculation
                if (!diyanetData.data || !diyanetData.data.timings || !mwlIshaData.data || !mwlIshaData.data.timings) {
                    throw new Error('Невалиден отговор от API или липсващи основни данни за времена за намаз.');
                }

                // Now proceed with prayer time calculation
                const sofiaBaseTimings = {
                    Fajr: diyanetData.data.timings.Fajr,
                    Sunrise: diyanetData.data.timings.Sunrise,
                    Dhuhr: diyanetData.data.timings.Dhuhr,
                    Asr: diyanetData.data.timings.Asr,
                    Maghrib: diyanetData.data.timings.Maghrib,
                    Isha: mwlIshaData.data.timings.Isha // Override Isha with MWL time
                };

                const currentCityCustomOffset = cityOffsets[selectedCity] || 0;
                const adjustedPrayerTimes = {};

                // Apply general and city-specific offsets to the API-fetched Sofia times
                for (const key of allPrayerKeys) { // Iterate through allPrayerKeys for consistent order
                    if (sofiaBaseTimings.hasOwnProperty(key)) {
                        let [hour, minute] = sofiaBaseTimings[key].split(':').map(Number);
                        let tempDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hour, minute, 0);

                        // Apply general prayer-specific adjustment
                        if (adjustments[key] !== undefined) { 
                            tempDate.setMinutes(tempDate.getMinutes() + adjustments[key]);
                        }
                        // Apply city-specific custom offset
                        tempDate.setMinutes(tempDate.getMinutes() + currentCityCustomOffset);

                        // Apply custom user adjustment (from local storage)
                        if (customPrayerAdjustments[key] !== undefined) {
                            tempDate.setMinutes(tempDate.getMinutes() + customPrayerAdjustments[key]);
                        }

                        adjustedPrayerTimes[key] = formatTime(tempDate);
                    }
                }
                
                prayerTimes = adjustedPrayerTimes; // Store the fully adjusted times

                // Handle Hijri date separately with its own checks for robustness for the top bar display
                if (diyanetData.data.date && diyanetData.data.date.hijri) {
                    const hijri = diyanetData.data.date.hijri;
                    if (hijri.day && hijri.month && hijri.month.en && hijri.year) {
                        const hijriDay = hijri.day;
                        const hijriMonthEnglish = hijri.month.en;
                        const hijriYear = hijri.year;
                        const hijriMonthBg = hijriMonthsBg[hijriMonthEnglish] || hijriMonthEnglish; 
                        currentHijriDate = `${hijriDay} ${hijriMonthBg} ${hijriYear} г.`; 
                        hijriDateEl.textContent = currentHijriDate;

                        // --- UPDATED LOGIC FOR SACRED DAY INFO ---
                        let foundSacredDay = '';
                        // Use selectedDate instead of new Date() (today)
                        const dateForSacredCheck = selectedDate; 
                        for (const event of HARDCODED_SACRED_EVENTS_2025) {
                            // Compare with selectedDate
                            if (event.date.toDateString() === dateForSacredCheck.toDateString()) { 
                                foundSacredDay = event.nameBg;
                                break;
                            }
                        }

                        if (foundSacredDay) {
                            sacredDayInfoEl.textContent = foundSacredDay; 
                            sacredDayInfoEl.classList.remove('hidden');
                        } else {
                            sacredDayInfoEl.textContent = '';
                            sacredDayInfoEl.classList.add('hidden');
                        }
                        // --- END UPDATED LOGIC ---

                    } else {
                        console.warn("Hijri date data incomplete from API response.");
                        currentHijriDate = 'Няма хиджри дата';
                        hijriDateEl.textContent = currentHijriDate;
                        sacredDayInfoEl.textContent = '';
                        sacredDayInfoEl.classList.add('hidden');
                    }
                } else {
                    console.warn("Hijri date object missing from API response.");
                    currentHijriDate = 'Няма хиджри дата';
                    hijriDateEl.textContent = currentHijriDate;
                    sacredDayInfoEl.textContent = '';
                    sacredDayInfoEl.classList.add('hidden');
                }

                displayPrayerTimes(); // Call display to render and manage countdowns
                
            } catch (error) {
                console.error('Error fetching prayer times:', error);
                errorMessageEl.classList.remove('hidden');
                errorMessageEl.textContent = `Възникна грешка при зареждане на времената за намаз: ${error.message}. Моля, проверете връзката си и опитайте отново.`;
                prayerTimes = {};
                prayerTimesListEl.innerHTML = '';
                hijriDateEl.textContent = '';
                sacredDayInfoEl.textContent = '';
                sacredDayInfoEl.classList.add('hidden');
            } finally {
                // Hide loading indicator
                loadingIndicatorEl.classList.add('hidden');
            }
        }

        // Function to display prayer times in the list
        function displayPrayerTimes() {
            prayerTimesListEl.innerHTML = ''; // Clear previous times

            const now = new Date(); // Current time for initial comparison
            const targetDate = selectedDate; 
            
            prayersDataForDisplay = []; // Clear and repopulate global array

            const currentPrayerNames = getCurrentPrayerNames();

            for (const key of allPrayerKeys) { 
                if (prayerTimes.hasOwnProperty(key)) {
                    const [hour, minute] = prayerTimes[key].split(':').map(Number);
                    let prayerDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate(), hour, minute, 0);

                    let displayName = currentPrayerNames[key] || key;
                    if (key === 'Dhuhr') {
                        displayName = getDhuhrName(targetDate); 
                    }

                    prayersDataForDisplay.push({
                        name: key,
                        displayName: displayName,
                        staticTime: formatTime(prayerDate), // Store static formatted time
                        date: prayerDate // Store the actual Date object for countdowns
                    });
                }
            }

            // Sort prayers by time to ensure correct order
            prayersDataForDisplay.sort((a, b) => a.date.getTime() - b.date.getTime());

            let highlightIndex = -1; // Use a separate variable for highlighting

            if (selectedDate.toDateString() === new Date().toDateString()) {
                // Only highlight if it's today's date
                for (let i = 0; i < prayersDataForDisplay.length; i++) {
                    if (prayersDataForDisplay[i].date > now) { 
                        highlightIndex = i; // Found a future prayer on current day to highlight
                        break;
                    }
                }
            } else {
                highlightIndex = -1; 
            }

            // Render prayer times initially with static times
            prayersDataForDisplay.forEach((prayer, index) => {
                const prayerRow = document.createElement('div');
                prayerRow.className = 'prayer-row';

                // Apply highlighting based on the separate highlightIndex
                if (index === highlightIndex) {
                    prayerRow.classList.add('highlighted-prayer');
                }

                // Render with static time. Dynamic updates will override this if countdown mode is active.
                prayerRow.innerHTML = `
                    <span class="prayer-name">${prayer.displayName}</span>
                    <div class="flex items-center">
                        <span class="prayer-time" id="prayer-time-${prayer.name}">${prayer.staticTime}</span>
                    </div>
                `;
                prayerTimesListEl.appendChild(prayerRow);
            });

            startStopIndividualCountdowns(); // Manage the individual countdown interval
            updateCountdown(); // Update the main countdown (to next prayer)
        }

        // Function to start or stop individual prayer countdowns in the list
        function startStopIndividualCountdowns() {
            clearInterval(individualCountdownIntervalId); // Always clear any existing interval first
            individualCountdownIntervalId = null;

            // In this design, individual prayer times in the list should always be static, matching the screenshot.
            // The isCountdownMode toggle applies only to the *main* countdown for next prayer/sacred event.
            prayersDataForDisplay.forEach(prayer => {
                const span = document.getElementById(`prayer-time-${prayer.name}`);
                if (span) {
                    span.textContent = prayer.staticTime; // Always display static time
                }
            });
            // Therefore, we do NOT start setInterval for individual countdowns here.
            // The isCountdownMode variable will now primarily control the main countdown display.
        }

        // Function to dynamically update individual prayer countdowns in the list
        // This function is effectively no longer used for the list display itself,
        // but it's kept here if the logic were to be re-introduced for list items.
        function updateIndividualCountdowns() {
            const now = new Date();
            prayersDataForDisplay.forEach(prayer => {
                const span = document.getElementById(`prayer-time-${prayer.name}`);
                if (span) {
                    const diffMs = prayer.date.getTime() - now.getTime();
                    // This part would be active if we wanted countdowns in the list
                    // span.textContent = formatDuration(diffMs);
                }
            });
        }

        // Helper function to calculate year, month, and day difference between two dates
        function getYearsMonthsDaysDifference(d1, d2) { 
            let years = d2.getFullYear() - d1.getFullYear();
            let months = d2.getMonth() - d1.getMonth();
            let days = d2.getDate() - d1.getDate();

            if (days < 0) {
                months--;
                let daysInPrevMonthOfD2 = new Date(d2.getFullYear(), d2.getMonth(), 0).getDate();
                days += daysInPrevMonthOfD2;
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            return { years, months, days };
        }

        // Function to update the countdown to the next prayer (main countdown)
        function updateCountdown() {
            const now = new Date();

            if (selectedDate.toDateString() !== now.toDateString()) {
                const diff = getYearsMonthsDaysDifference(now, selectedDate);
                let displayMessage = '';
                returnTodayBtn.classList.remove('hidden');

                if (selectedDate > now) {
                    if (diff.years > 0) {
                        displayMessage += `след ${diff.years} г.`;
                        if (diff.months > 0) {
                            displayMessage += ` ${diff.months} м.`;
                        }
                    } else if (diff.months > 0) {
                        displayMessage += `след ${diff.months} м.`;
                        if (diff.days > 0) {
                            displayMessage += ` ${diff.days} дни`;
                        }
                    } else if (diff.days > 0) {
                        displayMessage += `след ${diff.days} дни`;
                    } else {
                        countdownEl.textContent = '--:--:--';
                        countdownTextEl.textContent = 'Избрана е бъдеща дата.'; 
                        return;
                    }
                    countdownEl.textContent = '--:--:--'; 
                    countdownTextEl.textContent = displayMessage || 'Изберете дата.';
                } else {
                    countdownEl.textContent = '--:--:--';
                    countdownTextEl.textContent = 'Избрана е минала дата.';
                }
                return;
            }

            returnTodayBtn.classList.add('hidden');

            if (Object.keys(prayerTimes).length === 0) {
                countdownEl.textContent = '--:--:--';
                countdownTextEl.textContent = 'Няма отброяване за избраната дата.';
                return;
            }

            let nextPrayerTimeDate;
            let nextPrayerDisplayName;
            
            let prayersArrayForCountdown = prayersDataForDisplay;

            nextPrayerIndex = -1; 
            for (let i = 0; i < prayersArrayForCountdown.length; i++) {
                if (prayersArrayForCountdown[i].date > now) {
                    nextPrayerIndex = i;
                    break;
                    }
                }
            
            if (nextPrayerIndex === -1 && prayersArrayForCountdown.length > 0) {
                nextPrayerIndex = 0; 
                const nextDayFajr = new Date(prayersArrayForCountdown[0].date);
                nextDayFajr.setDate(nextDayFajr.getDate() + 1);
                nextPrayerTimeDate = nextDayFajr;
                nextPrayerDisplayName = prayersArrayForCountdown[0].displayName;
                countdownTextEl.textContent = `до ${nextPrayerDisplayName} утре`;
            } else if (nextPrayerIndex !== -1) {
                const nextPrayer = prayersArrayForCountdown[nextPrayerIndex];
                nextPrayerTimeDate = nextPrayer.date;
                nextPrayerDisplayName = nextPrayer.displayName;
                countdownTextEl.textContent = `до ${nextPrayerDisplayName}`;
            } else {
                countdownEl.textContent = '00:00:00';
                countdownTextEl.textContent = 'Всички намази за днес са минали.';
                return;
            }

            const diff = nextPrayerTimeDate.getTime() - now.getTime();

            if (diff <= 0) {
                countdownEl.textContent = '00:00:00';
                countdownTextEl.textContent = 'Намазът е сега!';
                fetchPrayerTimes(); 
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Function to return to today's date
        function returnToToday() {
            selectedDate = new Date();
            hiddenDateInput.value = formatDateForInputAndLookup(selectedDate);
            fetchPrayerTimes(); 
        }

        // --- Modals Logic ---
        function openAdjustmentModal() {
            adjustmentModal.classList.remove('hidden');
            prayerAdjustmentInputsContainer.innerHTML = '';
            const currentPrayerNames = getCurrentPrayerNames();

            allPrayerKeys.forEach(key => {
                const adjustmentValue = customPrayerAdjustments[key] !== undefined ? customPrayerAdjustments[key] : 0;
                const displayName = currentPrayerNames[key] || key;
                const dhuhrDisplayName = key === 'Dhuhr' ? getDhuhrName(new Date()) : displayName;

                const inputRow = document.createElement('div');
                inputRow.className = 'adjustment-input-row';
                inputRow.innerHTML = `
                    <label for="adj-${key}">${dhuhrDisplayName}:</label>
                    <input type="number" id="adj-${key}" data-prayer-key="${key}" value="${adjustmentValue}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-600 border-gray-500 text-white" placeholder="Напр. 5 или -3">
                `;
                prayerAdjustmentInputsContainer.appendChild(inputRow);
            });
            
        }

        function closeAdjustmentModal() {
            adjustmentModal.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
        }

        function saveAllAdjustments() {
            let changesMade = false;
            let hasInvalidInput = false;
            allPrayerKeys.forEach(key => {
                const inputElement = document.getElementById(`adj-${key}`);
                if (inputElement) {
                    const newOffset = parseInt(inputElement.value, 10);
                    if (isNaN(newOffset)) {
                        errorMessageEl.textContent = `Невалидно число за корекция на ${getCurrentPrayerNames()[key] || key}. Моля, въведете валидно число (напр. 5 или -3).`;
                        errorMessageEl.classList.remove('hidden');
                        hasInvalidInput = true;
                        return;
                    }

                    if (customPrayerAdjustments[key] !== newOffset) {
                        customPrayerAdjustments[key] = newOffset;
                        changesMade = true;
                    }
                }
            });

            if (!hasInvalidInput) {
                if (changesMade) {
                    saveSettings();
                    fetchPrayerTimes();
                }
                closeAdjustmentModal();
            }
        }


        function openCitySelectionModal() {
            citySelectionModal.classList.remove('hidden');
            populateCityList();
        }

        function closeCitySelectionModal() {
            citySelectionModal.classList.add('hidden');
        }

        // --- View Switching Logic ---
        function showPrayerTimesView() {
            sacredEventsView.classList.add('hidden');
            prayerTimesView.classList.remove('hidden');
            mainActionButtons.classList.remove('hidden'); // Show main action buttons
            clearInterval(sacredEventsCountdownIntervalId); // Stop individual sacred event countdown
            clearInterval(sacredEventsMainCountdownIntervalId); // NEW: Stop main sacred event countdown
            sacredEventsCountdownIntervalId = null;
            sacredEventsMainCountdownIntervalId = null;
            fetchPrayerTimes();
        }

        async function showSacredEventsView() {
            prayerTimesView.classList.add('hidden');
            sacredEventsView.classList.remove('hidden');
            mainActionButtons.classList.add('hidden'); // Hide main action buttons
            clearInterval(individualCountdownIntervalId);
            individualCountdownIntervalId = null;

            await populateSacredEventsList(); // Populates eventsToToogleDisplay
            updateSacredEventsMainCountdown(); // Call once immediately
            sacredEventsMainCountdownIntervalId = setInterval(updateSacredEventsMainCountdown, 1000); // Update every second
        }

        // Function to populate the list of sacred events in the view
        async function populateSacredEventsList() {
            sacredEventsListEl.innerHTML = '';
            sacredEventsLoadingIndicator.classList.remove('hidden');

            const eventsToDisplay = [];
            HARDCODED_SACRED_EVENTS_2025.forEach(event => {
                eventsToDisplay.push({
                    name: event.nameBg,
                    date: event.date,
                    key: event.key
                });
            });

            if (eventsToDisplay.length === 0) {
                sacredEventsListEl.innerHTML = '<div class="text-center text-gray-400 py-4">Няма намерени свещени събития за 2025 г.</div>';
            } else {
                eventsToToogleDisplay = eventsToDisplay;
                eventsToToogleDisplay.sort((a, b) => a.date.getTime() - b.date.getTime()); 
                renderSacredEventsListDisplay();
            }
            sacredEventsLoadingIndicator.classList.add('hidden');
        }

        // Function to render or update the sacred events list display (date or countdown)
        function renderSacredEventsListDisplay() {
            sacredEventsListEl.innerHTML = '';

            clearInterval(sacredEventsCountdownIntervalId);
            sacredEventsCountdownIntervalId = null;

            let nextUpcomingEventElement = null; // To store the element to scroll to
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            eventsToToogleDisplay.forEach(event => {
                const eventRow = document.createElement('div');
                eventRow.className = 'prayer-row';

                const displayValue = isSacredEventsCountdownMode ? formatSacredEventDisplay(event.date) : formatDate(event.date);

                // Determine if this event is the "next upcoming" one
                const startOfEventDay = new Date(event.date.getFullYear(), event.date.getMonth(), event.date.getDate());
                if (!nextUpcomingEventElement && startOfEventDay >= startOfToday) {
                    // This is the first event that is today or in the future
                    eventRow.classList.add('highlighted-prayer'); // Highlight it
                    nextUpcomingEventElement = eventRow; // Mark this element for scrolling
                } else if (!isSacredEventsCountdownMode && event.date < now) {
                    eventRow.classList.add('opacity-50');
                }

                const uniqueId = `sacred-event-time-${event.key}`;
                eventRow.innerHTML = `
                    <span class="prayer-name">${event.name}</span>
                    <span class="prayer-time" id="${uniqueId}">${displayValue}</span>
                `;
                sacredEventsListEl.appendChild(eventRow);
            });

            // After all elements are rendered, scroll to the next upcoming one
            if (nextUpcomingEventElement) {
                // Use a timeout to ensure the DOM is fully rendered and the scrollIntoView works reliably
                setTimeout(() => {
                    nextUpcomingEventElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100); // Small delay
            }


            if (isSacredEventsCountdownMode) {
                // Update interval to use the new formatting function
                sacredEventsCountdownIntervalId = setInterval(() => {
                    eventsToToogleDisplay.forEach(event => {
                        const uniqueId = `sacred-event-time-${event.key}`;
                        const span = document.getElementById(uniqueId);
                        if (span) {
                            span.textContent = formatSacredEventDisplay(event.date); // Update with new format
                        }
                    });
                }, 1000);
            }
        }

        // NEW: Function to update the main sacred events countdown
        function updateSacredEventsMainCountdown() {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            let nextEvent = null;
            let nextEventIndex = -1;

            // Find the next upcoming event
            for (let i = 0; i < eventsToToogleDisplay.length; i++) {
                const eventDate = eventsToToogleDisplay[i].date;
                const startOfEventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());

                if (startOfEventDay >= startOfToday) { // Event is today or in the future
                    nextEvent = eventsToToogleDisplay[i];
                    nextEventIndex = i;
                    break;
                }
            }

            if (nextEvent) {
                const startOfNextEventDay = new Date(nextEvent.date.getFullYear(), nextEvent.date.getMonth(), nextEvent.date.getDate());
                const diffMs = startOfNextEventDay.getTime() - startOfToday.getTime();
                const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24)); // Round to nearest day

                if (diffDays === 0) {
                    sacredCountdownDisplay.textContent = 'Днес';
                    sacredCountdownText.textContent = `е ${nextEvent.name}`;
                } else if (diffDays === 1) {
                    sacredCountdownDisplay.textContent = 'Утре';
                    sacredCountdownText.textContent = `е ${nextEvent.name}`;
                } else {
                    sacredCountdownDisplay.textContent = `${diffDays} дни`;
                    sacredCountdownText.textContent = `до ${nextEvent.name}`;
                }
            } else {
                // All events for the year have passed
                sacredCountdownDisplay.textContent = '-- дни --';
                sacredCountdownText.textContent = 'Всички събития за 2025 г. са минали.';
            }
        }


        // --- Local Storage Functions ---
        function saveSettings() {
            const settingsToSave = {
                selectedCity: selectedCity,
                customPrayerAdjustments: customPrayerAdjustments,
                isClassicalNamesActive: isClassicalNamesActive,
                isSacredEventsCountdownMode: isSacredEventsCountdownMode,
            };
            try {
                localStorage.setItem('prayerApp_settings', JSON.stringify(settingsToSave));
            } catch (e) {
                console.error("Неуспешно запазване на настройките в localStorage:", e);
                errorMessageEl.textContent = 'Неуспешно запазване на настройките.';
                errorMessageEl.classList.remove('hidden');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('prayerApp_settings'));
                if (savedSettings) {
                    selectedCity = savedSettings.selectedCity || "София";
                    customPrayerAdjustments = savedSettings.customPrayerAdjustments || {};
                    isClassicalNamesActive = savedSettings.isClassicalNamesActive || false;
                    isSacredEventsCountdownMode = savedSettings.isSacredEventsCountdownMode || false;
                    
                    selectedCityDisplay.textContent = selectedCity;
                }
                selectedDate = new Date(); 
                hiddenDateInput.value = formatDateForInputAndLookup(selectedDate);
            }
            catch (e) {
                console.error("Неуспешно зареждане на настройките от localStorage:", e);
                errorMessageEl.textContent = 'Възникна проблем при зареждане на настройките. Използват се настройки по подразбиране.';
                errorMessageEl.classList.remove('hidden');
            }
        }

        // Initial setup and periodic updates
        window.onload = function() {
            loadSettings();
            
            updateClock();
            fetchPrayerTimes();

            locationSelectBtn.addEventListener('click', openCitySelectionModal);
            closeCityModalBtn.addEventListener('click', closeCitySelectionModal);
            citySelectionModal.addEventListener('click', (event) => {
                if (event.target === citySelectionModal) {
                    closeCitySelectionModal();
                }
            });

            countdownToggleButton.addEventListener('click', () => {
                isCountdownMode = !isCountdownMode;
                displayPrayerTimes();
            });

            datePickerBtn.addEventListener('click', () => {
                hiddenDateInput.showPicker();
            });

            hiddenDateInput.addEventListener('change', (event) => {
                selectedDate = new Date(event.target.value);
                fetchPrayerTimes();
            });

            languageToggleBtn.addEventListener('click', () => {
                isClassicalNamesActive = !isClassicalNamesActive;
                saveSettings();
                fetchPrayerTimes();
            });
            
            openAdjustmentModalBtn.addEventListener('click', openAdjustmentModal);
            cancelAdjustmentBtn.addEventListener('click', closeAdjustmentModal);
            saveAllAdjustmentsBtn.addEventListener('click', saveAllAdjustments); 

            returnTodayBtn.addEventListener('click', returnToToday);

            // --- Sacred Events View Event Listeners ---
            openSacredEventsToggleBtn.addEventListener('click', showSacredEventsView);
            backToPrayerTimesBtn.addEventListener('click', showPrayerTimesView);

            toggleSacredEventsCountdownBtn.addEventListener('click', () => {
                isSacredEventsCountdownMode = !isSacredEventsCountdownMode;
                saveSettings();
                renderSacredEventsListDisplay();
            });

            setInterval(updateClock, 1000);
            setInterval(updateCountdown, 1000);
        };
    </script>
</body>
</html>
